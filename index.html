<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Transferencias</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/scroller/2.0.6/css/scroller.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="0.5"/></pattern></defs><rect width="100" height="20" fill="url(%23grid)"/></svg>');
            pointer-events: none;
            z-index: -1;
        }

        .container-fluid {
            padding-left: 15px;
            padding-right: 15px;
            position: relative;
        }

        /* Contenedor principal del dashboard */
        #mainContent {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 25px;
        }

        .nav-tabs .nav-link {
            font-size: 1rem;
            padding: 12px 25px;
            border-radius: 10px 10px 0 0;
            margin-right: 3px;
            font-weight: 600;
            color: #6c757d;
            background: transparent;
            border: 1px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tabs .nav-link:hover {
            color: #002060;
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        .nav-tabs .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: none;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            overflow: hidden;
            background: white;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            font-weight: 600;
            font-size: 1.1rem;
            border-radius: 0;
            padding: 15px 20px;
            border-bottom: none;
            position: relative;
        }

        .card-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 100%);
        }

        .card-body {
            padding: 20px;
            position: relative;
            min-height: 300px;
        }

        /* Estilos específicos para gráficos */
        .card canvas {
            max-height: 250px !important;
        }

        /* Mejorar la leyenda de almacenes */
        .warehouse-legend-table {
            margin-top: 15px;
            width: 100%;
            font-size: 0.85rem;
            border-collapse: collapse;
        }

        .warehouse-legend-table th {
            background: #f8f9fa;
            padding: 8px;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
        }

        .warehouse-legend-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .warehouse-legend-table tr:hover {
            background: #f8f9fa;
        }

        /* Details/Summary para leyendas */
        details {
            margin-top: 15px;
        }

        summary {
            cursor: pointer;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-weight: 600;
            color: #495057;
            transition: all 0.2s ease;
        }

        summary:hover {
            background: #e9ecef;
            color: #002060;
        }

        details[open] summary {
            background: #002060;
            color: white;
            margin-bottom: 10px;
        }
        .table-modern {
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 0.81rem; /* reducido dos tamaños */
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,32,96,0.06);
            overflow: hidden;
            min-width: 350px;
            border-collapse: collapse;
        }
        .table-modern th, .table-modern thead th {
            background: #002060 !important;
            color: #fff !important;
            font-weight: 600 !important;
            font-size: 0.93rem !important; /* reducido dos tamaños */
            border-bottom: 2px solid #e0e0e0 !important;
            border-right: 1px solid #e0e0e0 !important;
            text-align: left !important;
            padding: 7px 8px !important;
            letter-spacing: 0.01em;
            transition: background 0.2s;
        }
        .table-modern th:last-child, .table-modern td:last-child {
            border-right: none !important;
        }
        .table-modern td {
            background: #fff;
            color: #222;
            font-size: 0.81rem; /* reducido dos tamaños */
            padding: 6px 8px !important;
            border-bottom: 1px solid #f0f0f0;
            border-right: 1px solid #e0e0e0;
            text-align: left;
            vertical-align: middle;
        }
        .table-modern tbody tr:nth-child(even) td {
            background: #f4f6fa;
        }
        .table-modern tbody tr:hover td {
            background: #e3e9f6;
        }
        /* Eliminar flechas de ordenamiento de DataTables */
        table.dataTable thead .sorting,
        table.dataTable thead .sorting_asc,
        table.dataTable thead .sorting_desc,
        table.dataTable thead .sorting_asc_disabled,
        table.dataTable thead .sorting_desc_disabled {
            background-image: none !important;
        }
        .dataTables_wrapper .dt-buttons .btn {
            margin-right: 4px;
            font-size: 0.81rem;
            padding: 3px 10px;
            border-radius: 4px;
            background: #e3e6ea;
            color: #222;
            border: 1px solid #d1d5db;
        }
        .dataTables_wrapper .dt-buttons .btn:hover {
            background: #002060;
            color: #fff;
        }
        .dataTables_filter input[type="search"] {
            border-radius: 4px;
            border: 1px solid #bfc5cc;
            padding: 4px 8px;
            font-size: 0.93rem;
            background: #f8f9fa;
            margin-left: 0.5em;
        }
        .status-badge {
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.88rem;
            font-weight: 500;
            background: #e9ecef;
            color: #555;
        }
        .status-badge.completed { background: #d1f5e0; color: #217a4a; }
        .status-badge.partial { background: #fff7d6; color: #a17d00; }
        .status-badge.pending { background: #fbe3e3; color: #a12a2a; }
        @media (max-width: 1200px) {
            .table-modern { font-size: 0.78rem; }
            .table-modern th, .table-modern td { padding: 5px 6px !important; }
        }
        @media (max-width: 900px) {
            .table-modern { font-size: 0.75rem; }
            .table-modern th, .table-modern td { padding: 4px 4px !important; }
        }
        @media (max-width: 700px) {
            .table-modern { font-size: 0.72rem; }
            .table-modern th, .table-modern td { padding: 3px 3px !important; }
        }
        @media (max-width: 600px) {
            .table-modern, .table-modern thead, .table-modern tbody, .table-modern th, .table-modern td, .table-modern tr {
                display: block;
                width: 100%;
            }
            .table-modern thead {
                display: none;
            }
            .table-modern tr {
                margin-bottom: 10px;
                border-radius: 8px;
                box-shadow: 0 1px 4px rgba(0,32,96,0.04);
                background: #fff;
            }
            .table-modern td {
                border: none;
                position: relative;
                padding-left: 50%;
                min-height: 28px;
                white-space: pre-line;
            }
            .table-modern td:before {
                position: absolute;
                top: 7px;
                left: 10px;
                width: 45%;
                white-space: pre-line;
                font-weight: bold;
                color: #002060;
                content: attr(data-label);
            }
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            border-radius: 4px;
            margin: 0 2px;
            border: 1px solid #e0e0e0;
            background: #f4f6fa;
            color: #002060 !important;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current,
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: #002060 !important;
            color: #fff !important;
            border: 1px solid #002060;
        }
        .dataTables_length label, .dataTables_filter label {
            font-weight: 500;
            color: #002060;
        }
        .table-responsive {
            overflow-x: auto;
        }
        .detalle-guia-info {
            font-size: 0.68em !important; /* bajado 3 tamaños */
            color: #8a8a8a !important;
            font-style: normal !important; /* quitar cursiva */
            margin-bottom: 0.5em;
        }
        /* Filtro discreto para almacén destino */
        .filtro-almacen-tipo {
            display: inline-block;
            margin-left: 10px;
            font-size: 0.82em;
            color: #555;
            background: #f4f6fa;
            border-radius: 6px;
            padding: 2px 8px;
            border: 1px solid #e0e0e0;
            vertical-align: middle;
        }
        .filtro-almacen-tipo label {
            margin-bottom: 0;
            margin-right: 8px;
            font-weight: 400;
            cursor: pointer;
        }
        .filtro-almacen-tipo input[type="checkbox"] {
            margin-right: 3px;
            vertical-align: middle;
        }
        /* Footer autor */
        .autor-footer {
            position: fixed;
            right: 12px;
            bottom: 12px;
            background: rgba(248,249,250,0.96);
            color: #444;
            font-size: 0.93rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 5px 16px;
            z-index: 2000;
            pointer-events: none;
            user-select: none;
            letter-spacing: 0.02em;
        }
        /* Botón fullscreen tabla resumen */
        #btnResumenFullscreen {
            float: right;
            margin-left: 10px;
            margin-bottom: 6px;
            font-size: 0.93rem;
            background: #002060;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 4px 14px;
            transition: background 0.2s;
        }
        #btnResumenFullscreen:hover {
            background: #003080;
            color: #fff;
        }
        .resumen-fullscreen-modal .modal-dialog {
            max-width: 98vw;
            width: 98vw;
            margin: 1vw auto;
        }
        .resumen-fullscreen-modal .modal-content {
            min-height: 90vh;
            background: #f6f7fb;
            border-radius: 12px;
            box-shadow: 0 4px 32px rgba(0,32,96,0.13);
            padding: 0;
        }
        .resumen-fullscreen-modal .modal-header {
            background: #002060;
            color: #fff;
            border-radius: 12px 12px 0 0;
            padding: 10px 24px;
        }
        .resumen-fullscreen-modal .modal-body {
            padding: 18px 18px 10px 18px;
        }
        .resumen-fullscreen-modal .table-modern {
            font-size: 0.93rem;
            min-width: 900px;
        }
        @media (max-width: 900px) {
            .resumen-fullscreen-modal .table-modern {
                font-size: 0.85rem;
                min-width: 600px;
            }
        }
        /* Equis para cerrar pantalla completa */
        #btnCerrarResumenFullscreen {
            position: absolute;
            top: 14px;
            right: 22px;
            z-index: 1052;
            background: rgba(0,0,0,0.07);
            border: none;
            color: #002060;
            font-size: 1.7rem;
            font-weight: bold;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            line-height: 1;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        #btnCerrarResumenFullscreen:hover {
            background: #002060;
            color: #fff;
        }
        .resumen-fullscreen-modal .modal-content {
            position: relative;
        }
        .resumen-fullscreen-modal {
            z-index: 1060 !important;
        }
        #detalleGuiaModal.modal {
            z-index: 21000 !important;
        }
        .modal-backdrop.show {
            z-index: 20999 !important;
        }
        #resumenFullscreenOverlay {
            display: none;
            position: fixed;
            z-index: 20000;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #f6f7fb;
            overflow: auto;
        }
        #resumenFullscreenOverlay .fullscreen-table-container {
            max-width: 98vw;
            margin: 2vh auto;
            padding: 2vh 2vw;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 32px rgba(0,32,96,0.13);
            font-size: 125%;
        }
        #resumenFullscreenOverlay .fullscreen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 18px;
        }
        #resumenFullscreenOverlay .fullscreen-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #002060;
            margin: 0;
        }
        #btnCloseResumenFullscreen {
            background: none;
            border: none;
            color: #002060;
            font-size: 2rem;
            font-weight: bold;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            line-height: 1;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        #btnCloseResumenFullscreen:hover {
            background: #002060;
            color: #fff;
        }
        @media (max-width: 900px) {
            #resumenFullscreenOverlay .fullscreen-table-container {
                padding: 1vh 0.5vw;
                min-width: 0;
            }
            #resumenFullscreenOverlay .fullscreen-title {
                font-size: 1.05rem;
            }
        }

        /* Estilos para tooltips mejorados */
        .tooltip-custom {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip-custom .tooltip-text {
            visibility: hidden;
            width: 280px;
            background: linear-gradient(135deg, rgba(0, 32, 96, 0.95) 0%, rgba(13, 71, 161, 0.95) 100%);
            backdrop-filter: blur(8px);
            color: #fff;
            text-align: left;
            border-radius: 10px;
            padding: 12px 16px;
            position: absolute;
            z-index: 1000;
            bottom: 135%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transform: translateY(8px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.85rem;
            line-height: 1.4;
            box-shadow: 0 10px 30px rgba(0, 32, 96, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .tooltip-custom .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: rgba(0, 32, 96, 0.95) transparent transparent transparent;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }
        
        .tooltip-custom:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        /* Efectos de hover mejorados para elementos interactivos */
        .tooltip-custom:hover {
            color: #667eea;
            transition: color 0.2s ease;
        }

        /* Skeleton loaders animados */
        .placeholder {
            background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%);
            border-radius: 5px;
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
        }
        
        @keyframes skeleton-loading {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: calc(200% + 200px) 0;
            }
        }

        /* Loading states avanzados con mejor UX */
        .section-loading {
            position: relative;
            pointer-events: none;
        }
        
        .section-loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(246, 247, 251, 0.9));
            backdrop-filter: blur(2px);
            z-index: 1000;
            border-radius: 12px;
            animation: fadeInLoading 0.3s ease-in-out;
        }
        
        /* Loading avanzado con elementos múltiples */
        .advanced-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.97), rgba(246, 247, 251, 0.95));
            backdrop-filter: blur(3px);
            z-index: 1001;
            border-radius: 12px;
            animation: fadeInLoading 0.3s ease-in-out;
        }
        
        .loading-spinner-advanced {
            position: relative;
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
        }
        
        .loading-spinner-advanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid rgba(0, 32, 96, 0.1);
            border-top: 3px solid #002060;
            border-radius: 50%;
            animation: spinAdvanced 1s linear infinite;
        }
        
        .loading-spinner-advanced::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            width: calc(100% - 16px);
            height: calc(100% - 16px);
            border: 2px solid transparent;
            border-top: 2px solid rgba(0, 32, 96, 0.5);
            border-radius: 50%;
            animation: spinAdvanced 2s linear infinite reverse;
        }
        
        .loading-text {
            color: #002060;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 10px;
            text-align: center;
            animation: pulseText 2s ease-in-out infinite;
        }
        
        .loading-subtext {
            color: #666;
            font-size: 14px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .loading-progress-bar {
            width: 200px;
            height: 6px;
            background: rgba(0, 32, 96, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .loading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #002060, #0056b3);
            border-radius: 3px;
            animation: progressFill 2s ease-in-out infinite;
            transform-origin: left;
        }
        
        .loading-dots {
            display: flex;
            gap: 6px;
        }
        
        .loading-dot {
            width: 8px;
            height: 8px;
            background: #002060;
            border-radius: 50%;
            animation: dotBounce 1.4s ease-in-out infinite both;
        }
        
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes spinAdvanced {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeInLoading {
            from { 
                opacity: 0; 
                transform: translateY(-10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes pulseText {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1); 
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.02); 
            }
        }
        
        @keyframes progressFill {
            0% { 
                transform: scaleX(0); 
            }
            50% { 
                transform: scaleX(0.7); 
            }
            100% { 
                transform: scaleX(1); 
            }
        }
        
        @keyframes dotBounce {
            0%, 80%, 100% { 
                transform: scale(0.8); 
                opacity: 0.5; 
            }
            40% { 
                transform: scale(1.2); 
                opacity: 1; 
            }
        }

        /* Mejoras visuales para progress bar */
        .progress {
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(45deg, #002060, #0066cc);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        /* Estilos para botones con tooltips */
        .btn-with-tooltip {
            position: relative;
        }
        
        .btn-with-tooltip[data-tooltip]:hover::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            font-size: 0.8rem;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
        }

        /* Chart loading states */
        /* SISTEMA ELIMINADO: .chart-loading - Reemplazado por Advanced Loading Overlay System */

        /* ===== NUEVO DISEÑO DE ÁREA DE CARGA ===== */
        .upload-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow-y: auto;
        }

        .upload-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="0.5"/></pattern></defs><rect width="100" height="20" fill="url(%23grid)"/></svg>');
            pointer-events: none;
        }

        .upload-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: slideUpFadeIn 0.8s ease-out;
        }

        @keyframes slideUpFadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Header Section */
        .upload-header {
            text-align: center;
            margin-bottom: 35px;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        .upload-logo {
            margin-bottom: 15px;
        }

        .upload-logo i {
            font-size: 3.5rem;
            color: #002060;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Animación de vibración para el botón de actualizar */
        @keyframes vibrateButton {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }
        
        .btn-vibrate {
            animation: vibrateButton 0.6s ease-in-out;
        }
        
        .btn-vibrate i {
            animation: pulse 0.6s ease-in-out;
        }

        .upload-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: #002060;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .upload-subtitle {
            font-size: 1.1rem;
            color: #6c757d;
            margin: 0;
            font-weight: 400;
        }

        /* Drop Zone */
        .upload-drop-zone {
            border: 3px dashed #d1d5db;
            border-radius: 15px;
            padding: 40px 30px;
            text-align: center;
            background: linear-gradient(45deg, #f8f9ff 0%, #fff 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            margin-bottom: 35px;
            animation: slideUpFadeIn 0.8s ease-out 0.4s both;
        }

        .upload-drop-zone:hover {
            border-color: #002060;
            background: linear-gradient(45deg, #f0f2ff 0%, #f8f9ff 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 32, 96, 0.1);
        }

        .upload-drop-zone.drag-over {
            border-color: #28a745;
            background: linear-gradient(45deg, #f0fff4 0%, #f8fff8 100%);
            transform: scale(1.02);
            box-shadow: 0 8px 30px rgba(40, 167, 69, 0.2);
        }

        .upload-drop-zone:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }

        .upload-icon-container {
            margin-bottom: 25px;
        }

        .upload-icon-background {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #002060 0%, #0d47a1 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            box-shadow: 0 8px 25px rgba(0, 32, 96, 0.3);
            transition: all 0.3s ease;
        }

        .upload-drop-zone:hover .upload-icon-background {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(0, 32, 96, 0.4);
        }

        .upload-main-icon {
            font-size: 2.5rem;
            color: white;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .upload-text-container {
            margin-bottom: 25px;
        }

        .upload-primary-text {
            font-size: 1.4rem;
            font-weight: 600;
            color: #002060;
            margin-bottom: 8px;
        }

        .upload-secondary-text {
            font-size: 1rem;
            color: #6c757d;
            margin: 0;
        }

        /* Format Info */
        .upload-format-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .format-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(0, 32, 96, 0.1);
            border-radius: 8px;
            font-weight: 500;
            color: #002060;
            transition: all 0.3s ease;
            cursor: default;
        }

        .format-item:hover {
            background: rgba(0, 32, 96, 0.15);
            transform: scale(1.05);
        }

        .format-item i {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .format-item:hover i {
            transform: rotate(5deg);
        }

        /* Browse Button */
        .upload-browse-btn {
            background: linear-gradient(135deg, #002060 0%, #0d47a1 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 32, 96, 0.3);
            position: relative;
            overflow: hidden;
        }

        .upload-browse-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s;
        }

        .upload-browse-btn:hover {
            background: linear-gradient(135deg, #0d47a1 0%, #1565c0 100%);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 32, 96, 0.5);
        }

        .upload-browse-btn:hover::before {
            left: 100%;
        }

        .upload-browse-btn:active {
            transform: translateY(-1px);
            transition: all 0.1s;
        }

        /* Features Section */
        .upload-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 25px 0;
            border-top: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
            animation: fadeInUp 0.8s ease-out 0.6s both;
        }

        .feature-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            text-align: left;
            transition: transform 0.3s ease;
        }

        .feature-item:hover {
            transform: translateY(-2px);
        }

        .feature-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .feature-icon i {
            color: white;
            font-size: 1.2rem;
        }

        .feature-text h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #002060;
            margin: 0 0 4px 0;
        }

        .feature-text p {
            font-size: 0.8rem;
            color: #6c757d;
            margin: 0;
            line-height: 1.3;
        }

        /* Requirements Section */
        .upload-requirements {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: slideInLeft 0.8s ease-out 0.8s both;
        }

        .upload-requirements h5 {
            font-size: 1rem;
            font-weight: 600;
            color: #002060;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .requirements-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .requirements-list li {
            font-size: 0.9rem;
            color: #495057;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            line-height: 1.4;
        }

        .requirements-list li:last-child {
            margin-bottom: 0;
        }

        /* Tips Section */
        .upload-tips {
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: slideInRight 0.8s ease-out 1s both;
        }

        .tip-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .tip-item:last-child {
            margin-bottom: 0;
        }

        .tip-item i {
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        /* Error Message */
        .upload-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 0;
            margin-top: 15px;
            display: none;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.15);
        }

        .upload-error.show {
            display: block;
            animation: shake 0.6s ease-in-out;
        }

        .error-content {
            padding: 15px 20px;
        }

        .error-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 1rem;
        }

        .error-header i {
            font-size: 1.2rem;
            color: #dc3545;
        }

        .error-message {
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .error-actions {
            display: flex;
            justify-content: flex-end;
        }

        .btn-dismiss {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-dismiss:hover {
            background: #c82333;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Estados de carga */
        .upload-container.processing .upload-drop-zone {
            pointer-events: none;
            opacity: 0.7;
            filter: blur(1px);
            transition: all 0.4s ease;
        }

        .upload-container.processing .upload-browse-btn {
            background: #6c757d;
            cursor: not-allowed;
            transform: none !important;
            animation: processingPulse 2s infinite;
        }

        .upload-container.processing .upload-main-icon {
            animation: processingRotate 2s linear infinite;
        }

        @keyframes processingPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes processingRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .upload-container {
                min-height: 100vh;
                padding: 15px;
            }

            .upload-content {
                padding: 30px 20px;
                margin: 0;
            }

            .upload-title {
                font-size: 1.8rem;
            }

            .upload-subtitle {
                font-size: 1rem;
            }

            .upload-drop-zone {
                padding: 30px 20px;
            }

            .upload-primary-text {
                font-size: 1.2rem;
            }

            .upload-secondary-text {
                font-size: 0.9rem;
            }

            .upload-features {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .upload-format-info {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }

            .upload-browse-btn {
                padding: 14px 25px;
                font-size: 1rem;
            }

            /* Hacer los botones más grandes para touch */
            .feature-item, .format-item {
                padding: 12px 16px;
            }
        }

        @media (max-width: 480px) {
            .upload-container {
                padding: 10px;
                min-height: 100vh;
            }

            .upload-content {
                padding: 25px 15px;
            }

            .upload-title {
                font-size: 1.5rem;
                line-height: 1.2;
            }

            .upload-subtitle {
                font-size: 0.9rem;
            }

            .upload-drop-zone {
                padding: 25px 15px;
            }

            .upload-icon-background {
                width: 60px;
                height: 60px;
            }

            .upload-main-icon {
                font-size: 2rem;
            }

            .upload-primary-text {
                font-size: 1.1rem;
            }

            .upload-secondary-text {
                font-size: 0.85rem;
            }

            .upload-browse-btn {
                padding: 16px 30px;
                font-size: 1.1rem;
                width: 100%;
                max-width: 280px;
            }

            .upload-features {
                padding: 20px 0;
            }

            .feature-text h4 {
                font-size: 0.95rem;
            }

            .feature-text p {
                font-size: 0.82rem;
            }

            .requirements-list li,
            .tip-item {
                font-size: 0.85rem;
            }

            /* Mejorar toque en móviles */
            .upload-drop-zone {
                min-height: 200px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
        }

        /* Touch-friendly hover effects para dispositivos táctiles */
        @media (hover: none) and (pointer: coarse) {
            .upload-drop-zone:hover {
                transform: none;
            }

            .upload-browse-btn:hover {
                transform: none;
            }

            .feature-item:hover {
                transform: none;
            }

            .format-item:hover {
                transform: none;
            }
        }

        /* Estilos de enfoque para accesibilidad */
        .upload-container:focus-visible,
        .upload-browse-btn:focus-visible,
        .format-item:focus-visible,
        .feature-item:focus-visible {
            outline: 3px solid #0066cc;
            outline-offset: 2px;
        }

        .upload-drop-zone:focus-within {
            border-color: #0066cc;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2);
        }

        /* Reducir animaciones para usuarios que prefieren menos movimiento */
        @media (prefers-reduced-motion: reduce) {
            .upload-content,
            .upload-header,
            .upload-drop-zone,
            .upload-features,
            .upload-requirements,
            .upload-tips {
                animation: none;
            }

            .upload-main-icon,
            .upload-logo i {
                animation: none;
            }

            * {
                transition: none !important;
            }
        }

        /* ===== ESTILOS DEL DASHBOARD ===== */
        
        /* Header del Dashboard */
        .dashboard-header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .dashboard-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
            font-weight: 300;
        }

        .dashboard-actions .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-weight: 600;
            padding: 10px 20px;
            transition: all 0.3s ease;
        }

        .dashboard-actions .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .dashboard-actions .btn:active {
            transform: translateY(0);
        }

        /* Tarjetas KPI */
        .kpi-card {
            background: white;
            border-radius: 15px;
            padding: 25px 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            height: 140px;
            display: flex;
            align-items: center;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .kpi-card.kpi-primary::before {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }

        .kpi-card.kpi-success::before {
            background: linear-gradient(135deg, #28a745 0%, #155724 100%);
        }

        .kpi-card.kpi-warning::before {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        }

        .kpi-card.kpi-danger::before {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .kpi-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            flex-shrink: 0;
        }

        .kpi-primary .kpi-icon {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .kpi-success .kpi-icon {
            background: linear-gradient(135deg, #28a745 0%, #155724 100%);
            color: white;
        }

        .kpi-warning .kpi-icon {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: white;
        }

        .kpi-danger .kpi-icon {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .kpi-icon i {
            font-size: 1.5rem;
        }

        .kpi-content {
            flex: 1;
        }

        .kpi-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0 0 5px 0;
            color: #2c3e50;
            line-height: 1;
        }

        .kpi-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin: 0 0 8px 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-percentage {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            background: #f8f9fa;
            color: #495057;
            display: inline-block;
        }

        .kpi-trend {
            font-size: 0.8rem;
        }

        .trend-indicator {
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        .trend-up {
            background: #d4edda;
            color: #155724;
        }

        .trend-down {
            background: #f8d7da;
            color: #721c24;
        }

        /* Tarjetas de Métricas */
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .metric-header {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .metric-header i {
            font-size: 1.1rem;
            color: #007bff;
        }

        .metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2c3e50;
            margin-top: 8px;
        }

        /* Animaciones de entrada */
        .kpi-card {
            animation: fadeInUp 0.6s ease-out;
        }

        .kpi-card:nth-child(1) { animation-delay: 0.1s; }
        .kpi-card:nth-child(2) { animation-delay: 0.2s; }
        .kpi-card:nth-child(3) { animation-delay: 0.3s; }
        .kpi-card:nth-child(4) { animation-delay: 0.4s; }

        .metric-card {
            animation: fadeInUp 0.6s ease-out 0.5s both;
        }

        /* Efectos de transición para tablas */
        .tab-pane {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Mejoras para el área de filtros */
        .form-check-inline {
            margin-right: 20px;
            margin-bottom: 10px;
        }

        .form-check-input:checked {
            background-color: #667eea;
            border-color: #667eea;
        }

        .form-check-label {
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .form-check-label:hover {
            color: #667eea;
        }

        /* Botones mejorados */
        .btn {
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Responsive para KPIs */
        @media (max-width: 768px) {
            #mainContent {
                padding: 20px 15px;
                margin: 10px 0;
            }

            .dashboard-header {
                padding: 20px 15px;
                margin-bottom: 20px;
            }

            .dashboard-title {
                font-size: 2rem;
            }

            .dashboard-subtitle {
                font-size: 1rem;
            }

            .kpi-card {
                padding: 20px 15px;
                height: 120px;
            }

            .kpi-icon {
                width: 50px;
                height: 50px;
                margin-right: 15px;
            }

            .kpi-icon i {
                font-size: 1.3rem;
            }

            .kpi-value {
                font-size: 1.8rem;
            }

            .metric-card {
                height: 90px;
                padding: 15px;
            }

            .metric-value {
                font-size: 1.2rem;
            }

            .nav-tabs .nav-link {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .card-body {
                padding: 15px;
            }
        }

        /* ===== ESTILOS PARA DRILL-DOWN MODAL ===== */
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #007bff;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            margin-bottom: 5px;
            font-weight: 700;
        }

        /* Mejorar modales */
        .modal-content {
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: none;
        }

        .modal-header {
            border-radius: 15px 15px 0 0;
            border-bottom: none;
            padding: 20px 30px;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            border-top: none;
            padding: 20px 30px;
            border-radius: 0 0 15px 15px;
        }

        /* Efectos de carga para gráficos interactivos */
        .chart-interactive {
            position: relative;
        }

        .chart-interactive::before {
            content: 'Haz clic en los elementos para ver detalles';
            position: absolute;
            bottom: 10px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        .chart-interactive:hover::before {
            opacity: 1;
        }

        /* Indicadores de loading mejorados */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: inherit;
        }

        /* SISTEMA ELIMINADO: .loading-spinner - Reemplazado por .loading-spinner-advanced */

        /* Badges mejorados */
        .badge {
            font-weight: 500;
            padding: 6px 10px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <!-- Spinner de carga mejorado con más detalles -->
    <div id="customLoading" style="display:none;" aria-live="polite" aria-busy="true" role="alertdialog">
        <div class="text-center w-100">
            <div class="d-flex justify-content-center align-items-center mb-3">
                <div class="spinner-border text-primary me-3" role="status" aria-label="Cargando"></div>
                <div>
                    <div id="customLoadingTitle" class="fw-bold fs-5">Procesando archivo...</div>
                    <div id="customLoadingSubtitle" class="text-muted small">Esto puede tomar unos momentos</div>
                </div>
            </div>
            <div class="progress mt-3" aria-label="Progreso de carga" style="height: 8px;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%"></div>
            </div>
            <div id="customLoadingMsg" class="mt-2 fw-bold text-primary">Iniciando procesamiento...</div>
            <div id="processingStats" class="mt-2 small text-muted"></div>
            <button id="cancelProcessing" class="btn btn-outline-danger btn-sm mt-3" style="display:none;">
                <i class="bi bi-x-circle"></i> Cancelar procesamiento
            </button>
        </div>
    </div>

    <!-- SISTEMA ELIMINADO: sectionLoadingOverlay - Reemplazado por Advanced Loading Overlay System -->

    <!-- Skeleton loaders para tablas -->
    <div id="tableSkeleton" style="display:none;" class="mt-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="placeholder-glow">
                <span class="placeholder col-3"></span>
            </div>
            <div class="placeholder-glow">
                <span class="placeholder col-2"></span>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th><span class="placeholder col-8"></span></th>
                        <th><span class="placeholder col-6"></span></th>
                        <th><span class="placeholder col-7"></span></th>
                        <th><span class="placeholder col-5"></span></th>
                        <th><span class="placeholder col-9"></span></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="placeholder col-12"></span></td>
                        <td><span class="placeholder col-8"></span></td>
                        <td><span class="placeholder col-10"></span></td>
                        <td><span class="placeholder col-6"></span></td>
                        <td><span class="placeholder col-4"></span></td>
                    </tr>
                    <tr>
                        <td><span class="placeholder col-9"></span></td>
                        <td><span class="placeholder col-11"></span></td>
                        <td><span class="placeholder col-7"></span></td>
                        <td><span class="placeholder col-8"></span></td>
                        <td><span class="placeholder col-6"></span></td>
                    </tr>
                    <tr>
                        <td><span class="placeholder col-11"></span></td>
                        <td><span class="placeholder col-6"></span></td>
                        <td><span class="placeholder col-9"></span></td>
                        <td><span class="placeholder col-7"></span></td>
                        <td><span class="placeholder col-5"></span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Área de carga mejorada -->
    <div id="loading" class="upload-container" tabindex="0" aria-label="Área de carga de archivo Excel" role="button" 
         aria-describedby="upload-instructions" aria-live="polite">
        <div class="upload-content">
            <!-- Header con título elegante -->
            <div class="upload-header">
                <div class="upload-logo">
                    <i class="bi bi-file-earmark-spreadsheet-fill"></i>
                </div>
                <h1 class="upload-title">Dashboard de Transferencias</h1>
                <p class="upload-subtitle">Analiza tus datos de transferencias de inventario</p>
            </div>

            <!-- Zona de drop principal -->
            <div class="upload-drop-zone" id="dropZone">
                <div class="upload-icon-container">
                    <div class="upload-icon-background">
                        <i class="bi bi-cloud-arrow-up upload-main-icon"></i>
                    </div>
                </div>
                
                <div class="upload-text-container">
                    <h3 class="upload-primary-text">Arrastra tu archivo aquí</h3>
                    <p class="upload-secondary-text">o haz clic para seleccionar desde tu computadora</p>
                </div>

                <!-- Información de formatos -->
                <div class="upload-format-info">
                    <div class="format-item">
                        <i class="bi bi-file-earmark-excel"></i>
                        <span>.xlsx</span>
                    </div>
                    <div class="format-item">
                        <i class="bi bi-file-earmark-excel-fill"></i>
                        <span>.xls</span>
                    </div>
                </div>

                <!-- Botón de acción principal -->
                <button type="button" class="upload-browse-btn" id="browseBtn" 
                        aria-describedby="upload-instructions" 
                        aria-label="Abrir selector de archivos Excel">
                    <i class="bi bi-folder2-open me-2" aria-hidden="true"></i>
                    Seleccionar archivo
                </button>
            </div>

            <!-- Instrucciones y características -->
            <div class="upload-features">
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="bi bi-lightning-charge"></i>
                    </div>
                    <div class="feature-text">
                        <h4>Procesamiento Rápido</h4>
                        <p>Web Workers para máximo rendimiento</p>
                    </div>
                </div>
                
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <div class="feature-text">
                        <h4>Datos Seguros</h4>
                        <p>Procesamiento local, sin subir a servidor</p>
                    </div>
                </div>
                
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <div class="feature-text">
                        <h4>Análisis Completo</h4>
                        <p>Gráficos interactivos y reportes detallados</p>
                    </div>
                </div>
            </div>

            <!-- Requisitos del archivo -->
            <div class="upload-requirements" id="upload-instructions">
                <h5><i class="bi bi-info-circle me-2" aria-hidden="true"></i>Requisitos del archivo:</h5>
                <ul class="requirements-list">
                    <li><i class="bi bi-check-circle text-success me-2"></i>Formato Excel (.xlsx o .xls)</li>
                    <li><i class="bi bi-check-circle text-success me-2"></i>Tamaño máximo: 50MB</li>
                    <li><i class="bi bi-check-circle text-success me-2"></i>Primera fila debe contener encabezados de columnas</li>
                    <li><i class="bi bi-check-circle text-success me-2"></i>Columnas requeridas: Fecha, Origen, Destino, Producto, Cantidad</li>
                </ul>
            </div>

            <!-- Tips adicionales -->
            <div class="upload-tips">
                <div class="tip-item">
                    <i class="bi bi-lightbulb text-warning"></i>
                    <span><strong>Tip:</strong> Asegúrate de que los datos estén limpios y sin filas vacías</span>
                </div>
                <div class="tip-item">
                    <i class="bi bi-clock text-info"></i>
                    <span><strong>Procesamiento:</strong> Archivos grandes pueden tomar varios segundos</span>
                </div>
                <div class="tip-item">
                    <i class="bi bi-shield-lock text-success"></i>
                    <span><strong>Privacidad:</strong> Tus datos no se envían a ningún servidor externo</span>
                </div>
            </div>

            <!-- Área de errores mejorada -->
            <div id="errorMsg" class="upload-error" role="alert" aria-live="assertive"></div>
        </div>
    </div>
    <input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none;" aria-label="Seleccionar archivo Excel">

    <div class="container-fluid mt-3" style="display:none;" id="mainContent">
        <!-- PESTAÑAS -->
        <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboardTab" type="button" role="tab" aria-controls="dashboardTab" aria-selected="true">
                    Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tablaGeneral-tab" data-bs-toggle="tab" data-bs-target="#tablaGeneralTab" type="button" role="tab" aria-controls="tablaGeneralTab" aria-selected="false">
                    Tabla General
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="resumen-tab" data-bs-toggle="tab" data-bs-target="#resumenTab" type="button" role="tab" aria-controls="resumenTab" aria-selected="false">
                    Resumen de Guías por Documento
                </button>
            </li>
        </ul>
        <div class="tab-content" id="mainTabsContent">
            <!-- DASHBOARD -->
            <div class="tab-pane fade show active" id="dashboardTab" role="tabpanel" aria-labelledby="dashboard-tab">
                <!-- Header del Dashboard -->
                <div class="dashboard-header mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="dashboard-title">Dashboard de Transferencias</h1>
                            <p class="dashboard-subtitle">Análisis completo de transferencias de inventario</p>
                        </div>
                        <div class="dashboard-actions">
                            <button type="button" id="refreshDashboardBtn" class="btn btn-outline-light" onclick="refreshDashboard()" 
                                    title="Actualizar datos del dashboard">
                                <i class="bi bi-arrow-clockwise me-2"></i>
                                Actualizar
                            </button>
                            <button type="button" class="btn btn-outline-light ms-2" onclick="exportDashboard()" 
                                    title="Exportar resumen del dashboard">
                                <i class="bi bi-download me-2"></i>
                                Exportar
                            </button>
                            <button type="button" class="btn btn-outline-warning ms-2" onclick="clearBlockedModals()" 
                                    title="Limpiar modales bloqueados">
                                <i class="bi bi-x-octagon me-2"></i>
                                Limpiar
                            </button>
                            <button type="button" class="btn btn-outline-info ms-2" onclick="generateDuplicationReport()" 
                                    title="Analizar duplicados en consola">
                                <i class="bi bi-search me-2"></i>
                                Analizar
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" onclick="togglePerformanceMonitor()" 
                                    title="Mostrar/ocultar monitor de performance">
                                <i class="bi bi-speedometer2 me-2"></i>
                                Monitor
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sección de KPIs principales -->
                <div class="row mb-4" id="kpiSection">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="kpi-card kpi-primary">
                            <div class="kpi-icon">
                                <i class="bi bi-file-earmark-text"></i>
                            </div>
                            <div class="kpi-content">
                                <h3 class="kpi-value" id="totalGuias">0</h3>
                                <p class="kpi-label">Total Guías</p>
                                <div class="kpi-trend">
                                    <span class="trend-indicator" id="guiasTrend"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="kpi-card kpi-success">
                            <div class="kpi-icon">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <div class="kpi-content">
                                <h3 class="kpi-value" id="guiasCompletas">0</h3>
                                <p class="kpi-label">Completas</p>
                                <div class="kpi-percentage" id="completasPercent">0%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="kpi-card kpi-warning">
                            <div class="kpi-icon">
                                <i class="bi bi-exclamation-triangle"></i>
                            </div>
                            <div class="kpi-content">
                                <h3 class="kpi-value" id="guiasParciales">0</h3>
                                <p class="kpi-label">Parciales</p>
                                <div class="kpi-percentage" id="parcialesPercent">0%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="kpi-card kpi-danger">
                            <div class="kpi-icon">
                                <i class="bi bi-clock-history"></i>
                            </div>
                            <div class="kpi-content">
                                <h3 class="kpi-value" id="guiasPendientes">0</h3>
                                <p class="kpi-label">Pendientes</p>
                                <div class="kpi-percentage" id="pendientesPercent">0%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Métricas adicionales -->
                <div class="row mb-4" id="metricsSection">
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="metric-card">
                            <div class="metric-header">
                                <i class="bi bi-building"></i>
                                <span>Almacenes Activos</span>
                            </div>
                            <div class="metric-value" id="totalAlmacenes">0</div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="metric-card">
                            <div class="metric-header">
                                <i class="bi bi-calendar-range"></i>
                                <span>Rango Fechas</span>
                            </div>
                            <div class="metric-value" id="rangoFechas">-</div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="metric-card">
                            <div class="metric-header">
                                <i class="bi bi-speedometer2"></i>
                                <span>Última Actualización</span>
                            </div>
                            <div class="metric-value" id="ultimaActualizacion">-</div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos principales -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card tooltip-custom" aria-label="Resumen de estados">
                            <div class="card-header">
                                Resumen de Estados
                                <i class="bi bi-info-circle ms-2" style="cursor: help;"></i>
                            </div>
                            <div class="card-body chart-interactive">
                                <canvas id="statusChart" aria-label="Gráfico de estados" title="Distribución de estados de las guías de transferencia"></canvas>
                            </div>
                            <span class="tooltip-text">Muestra la distribución de estados de todas las guías de transferencia: Aceptado-Total (completado), Aceptado-Parcial (parcialmente completado) y Pendiente-Total (sin procesar)</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card tooltip-custom" aria-label="Pendientes por almacén">
                            <div class="card-header">
                                Pendientes por Almacén
                                <i class="bi bi-info-circle ms-2" style="cursor: help;"></i>
                            </div>
                            <div class="card-body">
                                <canvas id="warehouseChart" aria-label="Gráfico de almacenes" title="Cantidad de guías pendientes por almacén de destino"></canvas>
                                <details open>
                                    <summary>Ver leyenda de almacenes</summary>
                                    <div id="warehouseLegend"></div>
                                </details>
                            </div>
                            <span class="tooltip-text">Visualiza la cantidad de guías pendientes o parcialmente aceptadas agrupadas por almacén de destino. Los números en el gráfico corresponden a los almacenes listados en la tabla inferior</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card tooltip-custom" aria-label="Pendientes por fecha">
                            <div class="card-header">
                                Pendientes por Fecha
                                <i class="bi bi-info-circle ms-2" style="cursor: help;"></i>
                            </div>
                            <div class="card-body">
                                <canvas id="dateChart" aria-label="Gráfico de fechas" title="Tendencia de guías pendientes por fecha de origen"></canvas>
                            </div>
                            <span class="tooltip-text">Muestra la tendencia temporal de las guías pendientes o parcialmente aceptadas según su fecha de origen, útil para identificar períodos con mayor volumen de transferencias sin completar</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- TABLA GENERAL -->
            <div class="tab-pane fade" id="tablaGeneralTab" role="tabpanel" aria-labelledby="tablaGeneral-tab">
                <div class="row mb-3">
                    <div class="col-12 text-center">
                        <label class="me-3 fw-bold" for="filtroPendiente">
                            Filtrar por Estado Documento:
                            <i class="bi bi-info-circle ms-1 tooltip-custom" style="cursor: help;">
                                <span class="tooltip-text">Selecciona qué tipos de documentos mostrar en la tabla. Puedes seleccionar múltiples opciones.</span>
                            </i>
                        </label>
                        <div class="form-check form-check-inline tooltip-custom">
                            <input class="form-check-input estado-filter" type="checkbox" id="filtroPendiente" value="Pendiente-Total" checked aria-checked="true">
                            <label class="form-check-label" for="filtroPendiente">Pendiente-Total</label>
                            <span class="tooltip-text">Guías completamente sin procesar en el destino</span>
                        </div>
                        <div class="form-check form-check-inline tooltip-custom">
                            <input class="form-check-input estado-filter" type="checkbox" id="filtroParcial" value="Aceptado-Parcial" checked aria-checked="true">
                            <label class="form-check-label" for="filtroParcial">Aceptado-Parcial</label>
                            <span class="tooltip-text">Guías parcialmente recibidas en el destino</span>
                        </div>
                        <div class="form-check form-check-inline tooltip-custom">
                            <input class="form-check-input estado-filter" type="checkbox" id="filtroTotal" value="Aceptado-Total" checked aria-checked="true">
                            <label class="form-check-label" for="filtroTotal">Aceptado-Total</label>
                            <span class="tooltip-text">Guías completamente recibidas en el destino</span>
                        </div>
                        <div class="form-check form-check-inline ms-4 tooltip-custom">
                            <input class="form-check-input" type="checkbox" id="filtroDiferenteCero" aria-checked="false">
                            <label class="form-check-label" for="filtroDiferenteCero">Solo Diferencia ≠ 0</label>
                            <span class="tooltip-text">Muestra solo productos con diferencias entre cantidad origen y destino</span>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div style="overflow-x:auto;">
                            <div class="table-responsive mb-4">
                                <h3 class="mb-3">
                                    <span class="bi bi-list-columns-reverse me-2 text-primary"></span>
                                    Detalle de Movimientos de Transferencia
                                </h3>
                                <table id="estadoTable" class="table-modern" style="width:100%" aria-label="Detalle de movimientos de transferencia">
                                    <thead>
                                        <tr>
                                            <th class="grupo-origen">Sucursal</th>
                                            <th class="grupo-origen">Almacén</th>
                                            <th class="grupo-origen">Documento</th>
                                            <th class="grupo-origen">Fecha</th>
                                            <th>Código Producto</th>
                                            <th>Descripción</th>
                                            <th>Cant. Origen</th>
                                            <th class="grupo-destino">Sucursal</th>
                                            <th class="grupo-destino">Almacén</th>
                                            <th class="grupo-destino">Fecha</th>
                                            <th>Cant. Destino</th>
                                            <th>Diferencia</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- RESUMEN DE GUÍAS -->
            <div class="tab-pane fade" id="resumenTab" role="tabpanel" aria-labelledby="resumen-tab">
                <div class="row mt-2 mb-3">
                    <div class="col-md-2">
                        <label for="filtroDestinoResumen" class="form-label">Almacén Destino</label>
                        <select id="filtroDestinoResumen" class="form-select resumen-filter" aria-label="Filtrar por almacén destino">
                            <option value="">Todos</option>
                        </select>
                        <span class="filtro-almacen-tipo" id="filtroTipoAlmacen">
                            <label><input type="checkbox" value="Almacen" checked>Almacenes</label>
                            <label><input type="checkbox" value="Tienda" checked>Tiendas</label>
                        </span>
                    </div>
                    <div class="col-md-2">
                        <label for="filtroOrigenResumen" class="form-label">Almacén Origen</label>
                        <select id="filtroOrigenResumen" class="form-select resumen-filter" aria-label="Filtrar por almacén origen">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filtroEstadoResumen" class="form-label">Estado Documento</label>
                        <select id="filtroEstadoResumen" class="form-select resumen-filter" multiple aria-label="Filtrar por estado documento">
                            <option value="Pendiente-Total" selected>Pendiente-Total</option>
                            <option value="Aceptado-Parcial" selected>Aceptado-Parcial</option>
                            <option value="Aceptado-Total" selected>Aceptado-Total</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filtroFechaIniResumen" class="form-label">Fecha Desde</label>
                        <input type="date" id="filtroFechaIniResumen" class="form-control resumen-filter" aria-label="Filtrar desde fecha">
                    </div>
                    <div class="col-md-2">
                        <label for="filtroFechaFinResumen" class="form-label">Fecha Hasta</label>
                        <input type="date" id="filtroFechaFinResumen" class="form-control resumen-filter" aria-label="Filtrar hasta fecha">
                    </div>
                </div>
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h3 class="mb-0">
                            <span class="bi bi-clipboard-data me-2 text-success"></span>
                            Resumen de Guías de Transferencia
                        </h3>
                        <button id="btnResumenFullscreen" class="btn-with-tooltip" data-tooltip="Abrir tabla en pantalla completa con controles de zoom y exportación avanzada">
                            <span class="bi bi-arrows-fullscreen"></span> Pantalla Completa
                        </button>
                    </div>
                    <div style="overflow-x:auto;">
                        <div class="table-responsive mb-4">
                            <table id="resumenTable" class="table-modern" style="width:100%" aria-label="Resumen de guías de transferencia">
                                <thead>
                                    <tr>
                                        <th>Almacén Destino</th>
                                        <th>Almacén Origen</th>
                                        <th>Guía Remisión</th>
                                        <th>Fecha Guía</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para detalle de guía -->
    <div class="modal fade" id="detalleGuiaModal" tabindex="-1" aria-labelledby="detalleGuiaLabel" aria-hidden="true" role="dialog">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <div class="modal-title-toolbar w-100">
              <span>
                <span class="modal-title h5" id="detalleGuiaLabel">Detalle de Guía</span>
              </span>
              <div class="detalle-guia-toolbar"></div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div id="detalleGuiaInfo" class="detalle-guia-info mb-2"></div>
            <!-- Filtros para mostrar toda la guía o solo pendientes -->
            <div class="mb-2">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="detalleFiltro" id="detalleFiltroTodo" value="todo" checked>
                <label class="form-check-label" for="detalleFiltroTodo">Ver toda la guía</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="detalleFiltro" id="detalleFiltroPendiente" value="pendiente">
                <label class="form-check-label" for="detalleFiltroPendiente">Solo cantidad pendiente</label>
              </div>
            </div>
            <div style="overflow-x:auto;">
              <table class="table-modern" id="detalleGuiaTable" aria-label="Detalle de la guía seleccionada" style="width:100%">
                <thead>
                  <tr>
                    <th>Producto Código</th>
                    <th>Producto Descripción</th>
                    <th>Cantidad Origen</th>
                    <th>Cantidad Destino</th>
                    <th>Diferencia</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal pantalla completa resumen -->
    <div class="modal fade resumen-fullscreen-modal" id="modalResumenFullscreen" tabindex="-1" aria-labelledby="modalResumenFullscreenLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <button id="btnCerrarResumenFullscreen" title="Cerrar pantalla completa" type="button">&times;</button>
          <div class="modal-header">
            <h5 class="modal-title" id="modalResumenFullscreenLabel">Resumen de Guías de Transferencia (Pantalla Completa)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div id="contenedorTablaResumenFullscreen"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- Agrega este overlay al final del <body> -->
    <div id="resumenFullscreenOverlay" tabindex="-1" aria-modal="true" role="dialog" style="display:none;">
        <div class="fullscreen-table-container">
            <div class="fullscreen-header" style="gap:18px;">
                <span class="fullscreen-title">Resumen de Guías de Transferencia (Pantalla Completa)</span>
                <!-- Barra de zoom -->
                <div id="zoomBarWrapper" style="display:flex;align-items:center;gap:8px;">
                    <label for="zoomBar" style="font-size:1rem;color:#002060;font-weight:500;margin-bottom:0;">Zoom:</label>
                    <input type="range" id="zoomBar" min="10" max="150" value="100" step="1" style="width:110px;">
                    <span id="zoomValue" style="min-width:38px;display:inline-block;font-size:1rem;color:#002060;">100%</span>
                </div>
                <button id="btnExportarExcelFullscreen" title="Descargar detalle completo en Excel" style="font-size:1.5rem;background:none;border:none;color:#002060;cursor:pointer;">
                    <span class="bi bi-file-earmark-excel"></span> <span style="font-size:1rem;">Descargar Excel</span>
                </button>
                <button id="btnCloseResumenFullscreen" title="Cerrar pantalla completa" style="margin-left:8px;">&times;</button>
            </div>
            <div id="resumenFullscreenTableWrapper"></div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/scroller/2.0.6/js/dataTables.scroller.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
// --- VARIABLES GLOBALES ---
let rawData = [];
let processedData = [];
let estadoTable, resumenTable;
let statusChart, warehouseChart, dateChart;

// Web Worker para procesamiento de archivos
let excelWorker = null;
let isProcessingFile = false;

// Sistema de debouncing para filtros
const debounceTimers = {};

// Control de estado para pantalla completa
let resumenFullscreenActivo = false;

// Control para evitar duplicación de spinners
let tabChangeTimestamp = 0;

// Utilidades de debouncing
function debounce(func, delay, key = 'default') {
    return function (...args) {
        clearTimeout(debounceTimers[key]);
        debounceTimers[key] = setTimeout(() => func.apply(this, args), delay);
    };
}

// Clase para manejo de Web Worker
class ExcelProcessorManager {
    constructor() {
        this.worker = null;
        this.isProcessing = false;
    }
    
    initWorker() {
        if (this.worker) {
            this.worker.terminate();
        }
        
        // Detectar si estamos en un entorno que soporta Web Workers
        if (!this.canUseWorkers()) {
            console.info('🔧 Usando procesamiento principal (más compatible con archivos locales)');
            this.workerSupported = false;
            return false;
        }
        
        try {
            this.worker = new Worker('excel-worker.js');
            this.setupWorkerHandlers();
            this.workerSupported = true;
            console.info('✅ Web Worker inicializado correctamente');
            return true;
        } catch (error) {
            console.info('🔧 Fallback a procesamiento principal:', error.message);
            this.workerSupported = false;
            return false;
        }
    }
    
    canUseWorkers() {
        // Verificar si estamos en un protocolo que soporta Workers
        const protocol = window.location.protocol;
        const isFileProtocol = protocol === 'file:';
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        // Los Web Workers no funcionan bien con file:// protocol
        if (isFileProtocol) {
            return false;
        }
        
        // Verificar si Worker está disponible
        if (typeof Worker === 'undefined') {
            return false;
        }
        
        return true;
    }
    
    setupWorkerHandlers() {
        this.worker.onmessage = (e) => {
            const { type, percent, message, data, error, fileName, extraStats } = e.data;
            
            switch (type) {
                case 'progress':
                    this.updateProgress(percent, message, extraStats);
                    
                    // Mostrar preview de datos cuando tengamos información básica
                    if (percent >= 30 && !$('#mainContent').is(':visible')) {
                        this.showEarlyPreview(message);
                    }
                    break;
                    
                case 'complete':
                    this.handleProcessingComplete(data, fileName);
                    break;
                    
                case 'error':
                    this.handleProcessingError(error, fileName);
                    break;
                    
                case 'cancelled':
                    this.handleProcessingCancelled();
                    break;
            }
        };
    }
    
    // Mostrar preview temprano para reducir sensación de espera
    showEarlyPreview(message) {
        // Solo mostrar si aún estamos en la pantalla de carga
        if ($('#loading').is(':visible')) {
            // Transicionar suavemente
            $('#loading').fadeOut(300, () => {
                $('#customLoading').show();
                
                // Agregar mensaje informativo
                if (!$('#earlyPreviewInfo').length) {
                    $('#customLoading .text-center').append(`
                        <div id="earlyPreviewInfo" class="mt-3 p-3 bg-light border rounded">
                            <i class="bi bi-clock-history me-2"></i>
                            <small class="text-muted">
                                Los datos se están procesando y aparecerán progresivamente...
                            </small>
                        </div>
                    `);
                }
            });
        }
        
        this.worker.onerror = (error) => {
            this.handleProcessingError(`Error en Web Worker: ${error.message}`);
        };
    }
    
    async processFile(file) {
        if (this.isProcessing) {
            throw new Error('Ya hay un archivo siendo procesado');
        }
        
        this.isProcessing = true;
        showSectionLoading('mainContent', 'Preparando archivo para procesamiento...', 'Leyendo datos del archivo');
        
        try {
            const arrayBuffer = await file.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);
            
            if (this.worker) {
                // Usar Web Worker
                this.worker.postMessage({
                    type: 'process',
                    data: uint8Array,
                    fileName: file.name
                });
            } else {
                // Fallback a procesamiento principal
                setTimeout(() => this.processFallback(uint8Array, file.name), 100);
            }
        } catch (error) {
            this.handleProcessingError(`Error preparando archivo: ${error.message}`, file.name);
        }
    }
    
    async processFallback(data, fileName) {
        try {
            console.time('ProcessFallback');
            
            // Progreso optimizado con mejor feedback visual
            this.updateProgress(10, '🔄 Procesando archivo localmente...');
            
            // Usar requestIdleCallback si está disponible para mejor performance
            await new Promise(resolve => {
                if (window.requestIdleCallback) {
                    requestIdleCallback(resolve);
                } else {
                    setTimeout(resolve, 10);
                }
            });
            
            this.updateProgress(25, '📊 Leyendo estructura del archivo...');
            const workbook = XLSX.read(data, { 
                type: 'array',
                cellDates: true,
                cellNF: false,
                cellStyles: false // Deshabilitar estilos para mejor performance
            });
            this.updateProgress(50, 'Convirtiendo datos...');
            
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            this.updateProgress(75, 'Finalizando procesamiento...');
            
            // Procesar datos
            const processedRows = jsonData.map(row => {
                // Lógica básica de procesamiento
                const processed = { ...row };
                const cantidadOrigen = Number(processed['Producto Cantidad']) || 0;
                const cantidadDestino = Number(processed['Destino Cantidad']) || 0;
                
                if (cantidadDestino === 0) {
                    processed['Estado Documento'] = 'Pendiente-Total';
                } else if (cantidadDestino < cantidadOrigen) {
                    processed['Estado Documento'] = 'Aceptado-Parcial';
                } else {
                    processed['Estado Documento'] = 'Aceptado-Total';
                }
                
                return processed;
            });
            
            this.updateProgress(100, 'Completado');
            this.handleProcessingComplete(processedRows, fileName);
            
        } catch (error) {
            this.handleProcessingError(`Error en procesamiento alternativo: ${error.message}`, fileName);
        }
    }
    
    updateProgress(percent, message, extraStats = '') {
        // El sistema Advanced Loading Overlay no requiere actualizaciones de progreso manuales
        // La barra de progreso se actualiza automáticamente basada en tiempo
        
        // Actualizar solo el mensaje si es necesario
        if (message && percent > 50) {
            const overlay = $('#loading-mainContent');
            if (overlay.length > 0) {
                overlay.find('.loading-text').text(message);
                if (extraStats) {
                    overlay.find('.loading-subtext').last().text(extraStats);
                }
            }
        }
        
        // Mostrar estadísticas adicionales si están disponibles
        if (extraStats) {
            $('#processingStats').text(extraStats);
        }
        
        // Actualizar el botón de cancelar según el progreso
        const cancelBtn = $('#cancelProcessing');
        if (percent > 90) {
            cancelBtn.prop('disabled', true).text('Finalizando...');
        } else if (percent > 0) {
            cancelBtn.prop('disabled', false).text('Cancelar procesamiento');
        }
    }
    
    handleProcessingComplete(data, fileName) {
        processedData = data;
        rawData = data;
        
        // Verificar si los datos han cambiado para invalidar caché
        moduleCache.hasDataChanged(data);
        
        // Mostrar contenido con animación suave
        this.showContentProgressively(data, fileName);
        this.isProcessing = false;
        
        // Iniciar pre-carga inteligente de módulos en background
        if (data.length > 0) {
            setTimeout(() => {
                console.log('🚀 Iniciando pre-carga inteligente de módulos...');
                moduleCache.preloadAllModules(data);
            }, 1500); // Esperar a que se muestre el contenido inicial
        }
    }
    
    // Nueva función para mostrar contenido progresivamente
    showContentProgressively(data, fileName) {
        const totalRecords = data.length;
        
        // Ocultar loading principal
        hideSectionLoading('mainContent');
        
        // Mostrar contenido principal inmediatamente
        $('#loading').hide();
        $('#mainContent').show();
        
        // Mostrar loading específico para tablas y gráficos
        showSectionLoading('dashboardTab', 'Generando gráficos...');
        showSectionLoading('tablaGeneralTab', 'Preparando tabla...');
        showSectionLoading('resumenTab', 'Creando resumen...');
        
        // Inicializar componentes de forma escalonada
        setTimeout(() => {
            try {
                // 1. Inicializar tablas primero (más crítico)
                initializeTables();
                hideSectionLoading('tablaGeneralTab');
                renderEstadoTableImmediate(); // Usar versión sin debounce para velocidad
                
                // Notificación de progreso
                showNotification(`Tabla principal cargada (${totalRecords} registros)`, 'success', 2000);
                
                // 2. Generar gráficos después de un breve delay
                setTimeout(() => {
                    updateCharts();
                    hideSectionLoading('dashboardTab');
                    
                    // 3. Finalmente el resumen
                    setTimeout(() => {
                        renderResumenTable();
                        hideSectionLoading('resumenTab');
                        
                        // Mensaje final de éxito
                        showSuccessMessage(`Archivo "${fileName}" procesado exitosamente. ${totalRecords} registros cargados y visualizados.`);
                    }, 200);
                }, 300);
            } catch (error) {
                hideSectionLoading('dashboardTab');
                hideSectionLoading('tablaGeneralTab');
                hideSectionLoading('resumenTab');
                showError(`Error inicializando componentes: ${error.message}`);
            }
        }, 100);
    }
    
    handleProcessingError(error, fileName = '') {
        hideSectionLoading('mainContent');
        showError(`Error procesando ${fileName}: ${error}`);
        this.isProcessing = false;
    }
    
    handleProcessingCancelled() {
        hideSectionLoading('mainContent');
        showError('Procesamiento cancelado por el usuario');
        this.isProcessing = false;
    }
    
    cancelProcessing() {
        if (this.worker && this.isProcessing) {
            this.worker.postMessage({ type: 'cancel' });
        }
        this.isProcessing = false;
    }
}

// Instancia global del procesador
const excelProcessor = new ExcelProcessorManager();

// Botón para abrir pantalla completa
$('#btnResumenFullscreen').on('click', function() {
    if (resumenFullscreenActivo) return;
    resumenFullscreenActivo = true;

    // Clona SOLO el HTML visible de la tabla (con encabezados y filas actuales)
    let $clonedTable = $('#resumenTable').clone();
    $clonedTable.removeAttr('id');
    $clonedTable.removeClass('dataTable no-footer');
    $clonedTable.find('tr').removeClass();
    $clonedTable.find('th, td').removeClass();
    $clonedTable.find('tfoot').remove();

    // RECONSTRUIR EL THEAD MANUALMENTE
    // Borra el thead actual y crea uno nuevo con los títulos originales
    const headers = [
        "Almacén Destino",
        "Almacén Origen",
        "Guía Remisión",
        "Fecha Guía",
        "Estado"
    ];
    $clonedTable.find('thead').remove();
    const thead = $('<thead><tr></tr></thead>');
    headers.forEach(h => {
        thead.find('tr').append(`<th>${h}</th>`);
    });
    $clonedTable.prepend(thead);

    // Limpia el wrapper y agrega la tabla clonada
    $('#resumenFullscreenTableWrapper').html('').append($clonedTable);

    // Muestra el overlay
    $('#resumenFullscreenOverlay').fadeIn(120).focus();
    $('body').css('overflow', 'hidden');
});

// Botón y tecla ESC para cerrar pantalla completa
$('#btnCloseResumenFullscreen').on('click', cerrarPantallaCompletaResumen);
$('#resumenFullscreenOverlay').on('keydown', function(e) {
    if (e.key === "Escape") cerrarPantallaCompletaResumen();
});
function cerrarPantallaCompletaResumen() {
    if (!resumenFullscreenActivo) return;
    resumenFullscreenActivo = false;
    $('#resumenFullscreenTableWrapper').html('');
    $('#resumenFullscreenOverlay').fadeOut(120);
    $('body').css('overflow', '');
    // Limpia zoom
    $('#zoomBar').val(100);
    $('#zoomValue').text('100%');
}

// Filtro almacén destino: actualizar tabla inmediatamente
$(document).on('change', '#filtroTipoAlmacen input[type="checkbox"]', function() {
    renderResumenTable();
});

// --- UTILIDADES DE UI MEJORADAS ---
function showError(msg, type = 'error') {
    // Limpiar el mensaje anterior
    $('#errorMsg').removeClass('show');
    
    // Determinar el estilo basado en el tipo
    let iconClass = 'bi-exclamation-triangle';
    let title = 'Error';
    
    if (type === 'warning') {
        iconClass = 'bi-exclamation-circle';
        title = 'Advertencia';
    } else if (type === 'info') {
        iconClass = 'bi-info-circle';
        title = 'Información';
    }
    
    // Crear mensaje mejorado con HTML
    const errorHTML = `
        <div class="error-content">
            <div class="error-header">
                <i class="bi ${iconClass}"></i>
                <strong>${title}</strong>
            </div>
            <div class="error-message">${msg}</div>
            <div class="error-actions">
                <button type="button" class="btn-dismiss" onclick="$('#errorMsg').removeClass('show');">
                    <i class="bi bi-x"></i> Cerrar
                </button>
            </div>
        </div>
    `;
    
    $('#errorMsg').html(errorHTML).addClass('show');
    hideSectionLoading('mainContent');
    $('#loading').removeClass('processing disabled').show();
    $('#mainContent').hide();
    
    // Mostrar notificación de error
    showNotification(msg, type);
    
    // Auto-ocultar el error después de unos segundos (solo para info y warning)
    if (type !== 'error') {
        setTimeout(() => {
            $('#errorMsg').removeClass('show');
        }, 8000);
    }
}

// SISTEMA ELIMINADO: Advanced Loading Bar - Reemplazado por Advanced Loading Overlay System
// Todas las funciones de carga de archivos ahora usan showSectionLoading/hideSectionLoading

// Sistema de notificaciones mejorado
function showNotification(message, type = 'info', duration = 5000) {
    const notificationId = 'notification-' + Date.now();
    const typeClasses = {
        success: 'alert-success',
        error: 'alert-danger',
        warning: 'alert-warning',
        info: 'alert-info'
    };
    
    const notification = $(`
        <div id="${notificationId}" class="alert ${typeClasses[type]} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 500px;">
            <strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
    
    $('body').append(notification);
    
    // Auto-ocultar después del tiempo especificado
    setTimeout(() => {
        $(`#${notificationId}`).fadeOut(300, function() {
            $(this).remove();
        });
    }, duration);
}

function showSuccessMessage(message) {
    showNotification(message, 'success');
}

// Loading states para secciones específicas
// Variables para manejo de loading avanzado
let loadingTimeouts = new Map();
let loadingStartTimes = new Map();

function showSectionLoading(sectionId, message = 'Cargando...', subMessage = '') {
    const startTime = Date.now();
    loadingStartTimes.set(sectionId, startTime);
    
    // Agregar clase básica
    $(`#${sectionId}`).addClass('section-loading');
    
    // Crear overlay avanzado
    const overlayHtml = createAdvancedLoadingOverlay(message, subMessage, sectionId);
    
    // Remover overlay anterior si existe
    $(`#${sectionId} .advanced-loading-overlay`).remove();
    
    // Agregar nuevo overlay
    $(`#${sectionId}`).append(overlayHtml);
    
    // Simular progreso si toma más de 1 segundo
    loadingTimeouts.set(sectionId, setTimeout(() => {
        updateLoadingProgress(sectionId);
    }, 1000));
    
    // Sistema unificado - Solo Advanced Loading Overlay
}

function hideSectionLoading(sectionId) {
    const startTime = loadingStartTimes.get(sectionId);
    const duration = startTime ? Date.now() - startTime : 0;
    
    // Limpiar timeouts
    if (loadingTimeouts.has(sectionId)) {
        clearTimeout(loadingTimeouts.get(sectionId));
        loadingTimeouts.delete(sectionId);
    }
    
    // Animación de salida suave
    $(`#${sectionId} .advanced-loading-overlay`).fadeOut(300, function() {
        $(this).remove();
    });
    
    setTimeout(() => {
        $(`#${sectionId}`).removeClass('section-loading');
    }, 150);
    
    // Sistema unificado - Solo Advanced Loading Overlay
    
    // Limpiar datos
    loadingStartTimes.delete(sectionId);
    
    // Log de performance
    if (duration > 0) {
        console.log(`⚡ ${sectionId} cargado en ${duration}ms`);
    }
}

function createAdvancedLoadingOverlay(message, subMessage, sectionId) {
    const dataSize = typeof processedData !== 'undefined' ? processedData.length : 0;
    const estimatedTime = estimateLoadingTime(dataSize, sectionId);
    
    return `
        <div class="advanced-loading-overlay" id="loading-${sectionId}">
            <div class="loading-spinner-advanced"></div>
            <div class="loading-text">${message}</div>
            ${subMessage ? `<div class="loading-subtext">${subMessage}</div>` : ''}
            <div class="loading-progress-bar">
                <div class="loading-progress-fill"></div>
            </div>
            <div class="loading-subtext">
                ${dataSize > 0 ? `Procesando ${dataSize.toLocaleString()} registros` : 'Preparando datos'}
                ${estimatedTime ? ` • ~${estimatedTime}` : ''}
            </div>
            <div class="loading-dots">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
        </div>
    `;
}

function updateLoadingProgress(sectionId) {
    const overlay = $(`#loading-${sectionId}`);
    if (overlay.length === 0) return;
    
    const progressBar = overlay.find('.loading-progress-fill');
    const startTime = loadingStartTimes.get(sectionId);
    const elapsed = Date.now() - startTime;
    
    // Calcular progreso basado en tiempo transcurrido
    let progress = Math.min(90, (elapsed / 3000) * 100); // Max 90% hasta completar
    progressBar.css('transform', `scaleX(${progress / 100})`);
    
    // Actualizar mensaje si toma mucho tiempo
    if (elapsed > 3000) {
        overlay.find('.loading-subtext').last().html(
            `<strong>Procesando dataset grande...</strong> • Optimizando vista`
        );
    }
}

function estimateLoadingTime(dataSize, sectionId) {
    if (dataSize === 0) return null;
    
    let estimate = '';
    if (dataSize > 15000) {
        estimate = '3-5 seg';
    } else if (dataSize > 5000) {
        estimate = '1-3 seg';
    } else {
        estimate = '< 1 seg';
    }
    
    return estimate;
}

// Skeleton loaders para tablas
function showTableSkeleton(tableContainer) {
    $(tableContainer).hide();
    $('#tableSkeleton').show();
}

function hideTableSkeleton(tableContainer) {
    $('#tableSkeleton').hide();
    $(tableContainer).show();
}

// SISTEMA ELIMINADO: Chart Loading System - Ahora manejado por Advanced Loading Overlay System
// Los gráficos individuales usan showSectionLoading('dashboardTab') en lugar de chart-loading

function showMainContent() {
    // Mostrar contenido inmediatamente, componentes se cargarán después
    $('#loading').hide();
    $('#mainContent').show();
    
    // Usar requestAnimationFrame para mejor performance
    requestAnimationFrame(() => {
        initializeTables();
        requestAnimationFrame(() => {
            updateCharts();
        });
    });
}

// --- FLUJO DE IMPORTACIÓN ---
const columnasRequeridas = [
    "Transferencia Grupo",
    "Origen Sucursal",
    "Origen Almacen",
    "Origen Documento",
    "Origen Idmotivo",
    "Origen Motivo",
    "Origen Fecha",
    "Producto Codigo",
    "Producto Descripcion",
    "Producto Grupo",
    "Producto Sub Grupo",
    "Producto U.M.",
    "Producto Cantidad",
    "Destino Sucursal",
    "Destino Almacen",
    "Destino Documento",
    "Destino Idmotivo",
    "Destino Motivo",
    "Destino Fecha",
    "Destino Cantidad",
    "Diferencia de Cantidades"
];

function validarColumnas(datos) {
    if (!Array.isArray(datos) || !datos.length) return columnasRequeridas;
    const colsArchivo = Object.keys(datos[0]);
    return columnasRequeridas.filter(col => !colsArchivo.includes(col));
}

function handleFileInput(file) {
    if (!file) return;
    
    // *** FEEDBACK INMEDIATO *** - Mostrar loading antes de cualquier validación
    showSectionLoading('mainContent', `Preparando archivo "${file.name}"...`, `Tamaño: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
    
    // Validaciones con feedback
    setTimeout(() => {
        if (!file.name.match(/\.(xlsx|xls)$/i)) {
            hideSectionLoading('mainContent');
            showError('Archivo no válido. Selecciona un archivo Excel (.xlsx o .xls)');
            return;
        }
        
        // Validar tamaño de archivo (máximo 50MB)
        const maxSize = 50 * 1024 * 1024;
        if (file.size > maxSize) {
            hideSectionLoading('mainContent');
            showError('El archivo es demasiado grande. El tamaño máximo permitido es 50MB.');
            return;
        }
        
        showError('');
        // Actualizar mensaje del overlay existente si es necesario
        const overlay = $('#loading-mainContent .loading-text');
        if (overlay.length > 0) {
            overlay.text('Inicializando procesador...');
        }
        
        // Inicializar Web Worker con feedback
        setTimeout(() => {
            if (!excelProcessor.worker) {
                // Actualizar mensaje del overlay existente
                const overlay = $('#loading-mainContent .loading-text');
                if (overlay.length > 0) {
                    overlay.text('Configurando Web Worker...');
                }
                
                const workerInitialized = excelProcessor.initWorker();
                if (!workerInitialized) {
                    showNotification('Usando procesamiento alternativo (puede ser más lento)', 'warning');
                }
            }
            
            // Procesar archivo con Web Worker mejorado
            excelProcessor.processFile(file).catch(error => {
                hideSectionLoading('mainContent');
                showError(`Error procesando archivo: ${error.message}`);
            });
        }, 100);
    }, 50);
}

// --- EVENTOS DE IMPORTACIÓN ---
$(function () {
    // Inicialización completa al cargar la página
    excelProcessor.initWorker();
    
    // Inicializar tooltips mejorados
    initializeTooltips();
    
    // Configurar performance monitoring
    initializePerformanceMonitoring();
    
    // Botón de cancelar procesamiento
    $('#cancelProcessing').on('click', function() {
        if (excelProcessor.isProcessing) {
            excelProcessor.cancelProcessing();
            $(this).prop('disabled', true).text('Cancelando...');
        }
    });
    
    $('#loading').on('click keypress', function(e) {
        if (e.type === 'click' || e.key === 'Enter' || e.key === ' ') {
            if (!$('#loading').hasClass('disabled')) {
                $('#excelFile').val('');
                $('#excelFile').trigger('click');
            }
        }
    });
    $('#excelFile').on('change', function(e) {
        const file = e.target.files && e.target.files[0];
        handleFileInput(file);
    });
    $('#loading').on('dragover', function(e) {
        e.preventDefault();
        if (!$(this).hasClass('disabled')) {
            $(this).addClass('dragover');
            $('#dropZone').addClass('drag-over');
        }
    });
    $('#loading').on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        $('#dropZone').removeClass('drag-over');
    });
    $('#loading').on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        $('#dropZone').removeClass('drag-over');
        if ($(this).hasClass('disabled')) return;
        const files = e.originalEvent.dataTransfer.files;
        if (files && files.length) {
            handleFileInput(files[0]);
        }
    });

    // Event handler para el nuevo botón de seleccionar archivo
    $('#browseBtn').on('click keydown', function(e) {
        if (e.type === 'click' || e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            e.stopPropagation();
            if (!$('#loading').hasClass('disabled')) {
                $('#excelFile').val('');
                $('#excelFile').trigger('click');
            }
        }
    });

    // Mejorar navegación por teclado en elementos interactivos
    $('.format-item, .feature-item').attr('tabindex', '0').on('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
            $(this).trigger('click');
        }
    });
    $('#errorMsg').on('click', function() {
        $('#excelFile').val('');
        $('#loading').show();
        $('#mainContent').hide();
        hideLoadingBar();
        showError('');
        rawData = [];
        processedData = [];
        if (estadoTable) { estadoTable.clear().draw(); }
        if (resumenTable) { resumenTable.clear().draw(); }
        if (statusChart) { statusChart.destroy(); statusChart = null; }
        if (warehouseChart) { warehouseChart.destroy(); warehouseChart = null; }
        if (dateChart) { dateChart.destroy(); dateChart = null; }
    });
    // Event listeners con debouncing para mejor performance
    $(document).on('change', '.estado-filter, #filtroDiferenteCero', function() {
        // Mostrar indicador visual inmediato de que el filtro está cambiando
        const $this = $(this);
        const originalBg = $this.closest('.form-check').css('background-color');
        
        $this.closest('.form-check').css('background-color', '#f8f9fa');
        
        // Aplicar filtros con debounce
        renderEstadoTable();
        
        // Restaurar estilo después del debounce
        setTimeout(() => {
            $this.closest('.form-check').css('background-color', originalBg);
        }, 350);
    });
    // Debounced event listener para filtros de resumen
    const debouncedRenderResumen = debounce(renderResumenTable, 250, 'resumenTable');
    $(document).on('change', '.resumen-filter', debouncedRenderResumen);
});

// --- GESTIÓN DE MODALES ---
function clearBlockedModals() {
    try {
        console.log('Limpiando modales bloqueados...');
        
        // Cerrar todos los modales Bootstrap activos primero
        $('.modal').each(function() {
            const modal = bootstrap.Modal.getInstance(this);
            if (modal) {
                modal.hide();
            }
        });
        
        // Destruir todas las instancias de DataTables
        if ($.fn.DataTable) {
            $('.dataTable').each(function() {
                if ($.fn.DataTable.isDataTable(this)) {
                    $(this).DataTable().destroy();
                }
            });
        }
        
        // Forzar limpieza completa con timeout para asegurar que Bootstrap termine
        setTimeout(() => {
            // Remover todos los backdrops y modales
            $('.modal-backdrop').remove();
            $('.modal').remove();
            
            // Limpiar completamente el estado del body
            $('body').removeClass('modal-open modal-scrollbar-measure');
            $('body').css({
                'overflow': '',
                'padding-right': '',
                'position': '',
                'top': '',
                'z-index': ''
            });
            
            // Asegurar que no queden event listeners huérfanos
            $(document).off('keydown.bs.modal');
            
            console.log('Modales completamente limpiados');
        }, 200);
        
    } catch (error) {
        console.warn('Error al limpiar modales:', error);
        // Fallback de emergencia - limpiar forzadamente
        $('.modal-backdrop, .modal').remove();
        $('body').removeClass('modal-open').css({
            'overflow': '',
            'padding-right': ''
        });
    }
}

// --- OPTIMIZACIÓN DE PERFORMANCE Y DEDUPLICACIÓN ---
let uniqueGuides = new Map(); // Cache de guías únicas para performance
let dataMetrics = {}; // Cache de métricas calculadas

// --- SISTEMA DE CACHÉ INTELIGENTE PARA MÓDULOS ---
class ModuleCacheManager {
    constructor() {
        this.cache = new Map();
        this.preloadQueue = [];
        this.isPreloading = false;
        this.lastDataHash = '';
        this.cacheStats = {
            hits: 0,
            misses: 0,
            invalidations: 0
        };
    }
    
    // Generar hash de datos para detectar cambios
    generateDataHash(data) {
        if (!data || data.length === 0) return '';
        return data.length + '_' + (data[0] ? JSON.stringify(data[0]).substring(0, 100) : '');
    }
    
    // Verificar si los datos han cambiado
    hasDataChanged(data) {
        const currentHash = this.generateDataHash(data);
        const changed = currentHash !== this.lastDataHash;
        if (changed) {
            this.lastDataHash = currentHash;
            this.invalidateAll();
        }
        return changed;
    }
    
    // Obtener datos del caché
    get(moduleKey, filterKey = 'default') {
        const fullKey = `${moduleKey}_${filterKey}`;
        const cached = this.cache.get(fullKey);
        
        if (cached && this.isValidCache(cached)) {
            this.cacheStats.hits++;
            console.log(`🎯 Cache HIT para ${moduleKey}:${filterKey} (${cached.data.length} registros)`);
            return cached;
        }
        
        this.cacheStats.misses++;
        return null;
    }
    
    // Guardar datos en caché
    set(moduleKey, filterKey = 'default', data, metadata = {}) {
        const fullKey = `${moduleKey}_${filterKey}`;
        const cacheEntry = {
            data: data,
            metadata: metadata,
            timestamp: Date.now(),
            accessCount: 0,
            lastAccess: Date.now()
        };
        
        this.cache.set(fullKey, cacheEntry);
        console.log(`💾 Cached ${moduleKey}:${filterKey} (${data.length} registros)`);
        
        // Limpiar caché antiguo si crece mucho
        this.cleanupOldEntries();
    }
    
    // Verificar validez del caché (5 minutos de vida útil)
    isValidCache(cacheEntry, maxAge = 300000) {
        return (Date.now() - cacheEntry.timestamp) < maxAge;
    }
    
    // Pre-cargar todos los módulos de forma inteligente
    async preloadAllModules(sourceData) {
        if (this.isPreloading || !sourceData || sourceData.length === 0) return;
        
        this.isPreloading = true;
        console.time('Preload All Modules');
        
        try {
            // Preparar datos base una sola vez
            const baseData = {
                processedData: sourceData,
                uniqueGuides: getUniqueGuides(sourceData),
                metrics: calculateMetricsOptimized(sourceData),
                resumenData: this.buildResumenData(sourceData)
            };
            
            // Pre-cargar cada módulo con sus variaciones principales
            await this.preloadDashboardModule(baseData);
            await this.preloadTablaGeneralModule(baseData);
            await this.preloadResumenModule(baseData);
            
            console.timeEnd('Preload All Modules');
            console.log(`🚀 Pre-carga completa: ${this.cache.size} entradas en caché`);
            
        } catch (error) {
            console.error('Error en pre-carga:', error);
        } finally {
            this.isPreloading = false;
        }
    }
    
    // Pre-cargar módulo Dashboard con sus gráficos
    async preloadDashboardModule(baseData) {
        const { processedData, uniqueGuides, metrics } = baseData;
        
        // Cache métricas principales
        this.set('dashboard', 'kpis', metrics, { type: 'kpis' });
        
        // Pre-calcular datos de gráficos
        const chartData = this.prepareChartData(processedData, uniqueGuides);
        this.set('dashboard', 'charts', chartData, { type: 'charts' });
        
        // Simular delay mínimo para no bloquear UI
        await new Promise(resolve => setTimeout(resolve, 10));
    }
    
    // Pre-cargar módulo Tabla General con filtros comunes
    async preloadTablaGeneralModule(baseData) {
        const { processedData } = baseData;
        
        // Cache tabla completa
        this.set('tablaGeneral', 'all', processedData, { type: 'fullTable' });
        
        // Pre-calcular filtros más comunes
        const commonFilters = [
            { key: 'completas', filter: row => row['Estado Documento'] === 'Aceptado-Total' },
            { key: 'pendientes', filter: row => row['Estado Documento'] === 'Pendiente-Total' },
            { key: 'parciales', filter: row => row['Estado Documento'] === 'Aceptado-Parcial' },
            { key: 'diferenteCero', filter: row => Number(row['Diferencia de Cantidades']) > 0 }
        ];
        
        for (const { key, filter } of commonFilters) {
            const filtered = processedData.filter(filter);
            this.set('tablaGeneral', key, filtered, { type: 'filtered', filterType: key });
            await new Promise(resolve => setTimeout(resolve, 5));
        }
    }
    
    // Pre-cargar módulo Resumen con datos agrupados
    async preloadResumenModule(baseData) {
        const { resumenData } = baseData;
        
        // Cache resumen completo
        this.set('resumen', 'all', resumenData, { type: 'summary' });
        
        // Pre-calcular agrupaciones por almacén más comunes
        const warehouses = [...new Set(resumenData.map(r => r['Almacén Destino']))];
        if (warehouses.length <= 20) { // Solo si no son demasiados almacenes
            for (let i = 0; i < Math.min(5, warehouses.length); i++) {
                const warehouse = warehouses[i];
                const filtered = resumenData.filter(r => r['Almacén Destino'] === warehouse);
                this.set('resumen', `warehouse_${warehouse}`, filtered, { 
                    type: 'warehouseFiltered', 
                    warehouse: warehouse 
                });
                await new Promise(resolve => setTimeout(resolve, 3));
            }
        }
    }
    
    // Preparar datos para gráficos
    prepareChartData(processedData, uniqueGuides) {
        const statusCounts = {
            'Aceptado-Total': 0,
            'Aceptado-Parcial': 0,
            'Pendiente-Total': 0
        };
        
        // Contar estados únicos
        Object.values(uniqueGuides).forEach(estado => {
            if (statusCounts.hasOwnProperty(estado)) {
                statusCounts[estado]++;
            }
        });
        
        // Datos de almacenes (top 10)
        const warehouseCounts = {};
        Object.keys(uniqueGuides).forEach(doc => {
            const estado = uniqueGuides[doc];
            if (estado !== 'Aceptado-Total') {
                const row = processedData.find(r => r['Origen Documento'] === doc);
                if (row) {
                    const warehouse = row['Almacén Destino'];
                    warehouseCounts[warehouse] = (warehouseCounts[warehouse] || 0) + 1;
                }
            }
        });
        
        // Datos de fechas
        const dateCounts = {};
        Object.keys(uniqueGuides).forEach(doc => {
            const estado = uniqueGuides[doc];
            if (estado !== 'Aceptado-Total') {
                const row = processedData.find(r => r['Origen Documento'] === doc);
                if (row) {
                    const date = row['Origen Fecha'];
                    dateCounts[date] = (dateCounts[date] || 0) + 1;
                }
            }
        });
        
        return {
            statusCounts,
            warehouseCounts,
            dateCounts,
            timestamp: Date.now()
        };
    }
    
    // Construir datos de resumen (extraído para reutilizar)
    buildResumenData(processedData) {
        const resumenDocs = {};
        processedData.forEach(row => {
            const doc = row['Origen Documento'];
            if (!resumenDocs[doc]) {
                resumenDocs[doc] = {
                    'Almacén Destino': row['Almacén Destino'],
                    'Almacén Origen': row['Origen Almacen'],
                    'Guía Remisión': doc,
                    'Fecha Guía': row['Origen Fecha'],
                    'Estado Documento': row['Estado Documento']
                };
            }
        });
        return Object.values(resumenDocs);
    }
    
    // Invalidar todo el caché
    invalidateAll() {
        console.log('🧹 Invalidando caché completo...');
        this.cache.clear();
        this.cacheStats.invalidations++;
    }
    
    // Limpiar entradas antiguas (mantener solo las 50 más recientes)
    cleanupOldEntries() {
        if (this.cache.size <= 50) return;
        
        const entries = Array.from(this.cache.entries())
            .sort((a, b) => b[1].lastAccess - a[1].lastAccess)
            .slice(50);
            
        entries.forEach(([key]) => this.cache.delete(key));
        console.log(`🧹 Limpieza de caché: ${entries.length} entradas eliminadas`);
    }
    
    // Estadísticas del caché
    getStats() {
        const hitRate = this.cacheStats.hits + this.cacheStats.misses > 0 
            ? ((this.cacheStats.hits / (this.cacheStats.hits + this.cacheStats.misses)) * 100).toFixed(1)
            : 0;
            
        return {
            ...this.cacheStats,
            hitRate: `${hitRate}%`,
            cacheSize: this.cache.size,
            memoryUsage: `${(JSON.stringify([...this.cache.values()]).length / 1024).toFixed(1)} KB`
        };
    }
}

// Instancia global del cache manager
const moduleCache = new ModuleCacheManager();

function getUniqueGuides(data = processedData) {
    if (!data || data.length === 0) return [];
    
    // Intentar obtener del caché inteligente primero
    const cached = moduleCache.get('uniqueGuides', 'main');
    if (cached) {
        return cached.data;
    }
    
    // Usar cache legacy si los datos no han cambiado
    const dataKey = data.length + '_' + (data[0] ? data[0]['Origen Documento'] || '' : '');
    if (uniqueGuides.has(dataKey)) {
        const result = uniqueGuides.get(dataKey);
        // Guardar en cache inteligente para futuras consultas
        moduleCache.set('uniqueGuides', 'main', result, { source: 'legacy' });
        return result;
    }
    
    console.time('Deduplicating guides');
    
    // Crear mapa de guías únicas usando 'Origen Documento' como key
    const uniqueMap = new Map();
    
    for (const row of data) {
        const docId = row['Origen Documento'];
        if (docId && !uniqueMap.has(docId)) {
            uniqueMap.set(docId, row);
        }
    }
    
    const result = Array.from(uniqueMap.values());
    uniqueGuides.set(dataKey, result);
    
    // Guardar en caché inteligente
    moduleCache.set('uniqueGuides', 'main', result, { 
        source: 'computed', 
        originalSize: data.length,
        uniqueCount: result.length 
    });
    
    console.timeEnd('Deduplicating guides');
    performanceLog(`📊 Deduplicación: ${result.length} guías únicas de ${data.length} filas originales`);
    return result;
}

function calculateMetricsOptimized(data = processedData) {
    console.time('Calculating metrics');
    
    const uniqueData = getUniqueGuides(data);
    
    // Usar reduce para una sola pasada sobre los datos
    const metrics = uniqueData.reduce((acc, row) => {
        acc.totalGuias++;
        
        const estado = row['Estado Documento'];
        switch(estado) {
            case 'Aceptado-Total':
                acc.completas++;
                break;
            case 'Aceptado-Parcial':
                acc.parciales++;
                break;
            case 'Pendiente-Total':
                acc.pendientes++;
                break;
        }
        
        return acc;
    }, {
        totalGuias: 0,
        completas: 0,
        parciales: 0,
        pendientes: 0
    });
    
    // Calcular porcentajes
    metrics.completasPercent = metrics.totalGuias > 0 ? ((metrics.completas / metrics.totalGuias) * 100).toFixed(1) : '0.0';
    metrics.parcialesPercent = metrics.totalGuias > 0 ? ((metrics.parciales / metrics.totalGuias) * 100).toFixed(1) : '0.0';
    metrics.pendientesPercent = metrics.totalGuias > 0 ? ((metrics.pendientes / metrics.totalGuias) * 100).toFixed(1) : '0.0';
    
    console.timeEnd('Calculating metrics');
    return metrics;
}

// Cache para operaciones pesadas
function clearDataCache() {
    uniqueGuides.clear();
    dataMetrics = {};
    console.log('Cache de datos limpiado');
}

// --- ANÁLISIS AVANZADO DE DUPLICADOS ---
function analyzeDataDuplication(data = processedData) {
    if (!data || data.length === 0) return null;
    
    console.time('Analyzing duplicates');
    
    const duplicateAnalysis = {};
    const guideCounts = new Map();
    
    // Contar occurrencias de cada guía
    data.forEach(row => {
        const docId = row['Origen Documento'];
        if (docId) {
            guideCounts.set(docId, (guideCounts.get(docId) || 0) + 1);
        }
    });
    
    // Clasificar por nivel de duplicación
    let totalDuplicates = 0;
    let guidesWithDuplicates = 0;
    const duplicatesByCount = new Map();
    
    for (const [docId, count] of guideCounts) {
        if (count > 1) {
            guidesWithDuplicates++;
            totalDuplicates += (count - 1); // Total de filas duplicadas
            
            if (!duplicatesByCount.has(count)) {
                duplicatesByCount.set(count, []);
            }
            duplicatesByCount.get(count).push(docId);
        }
    }
    
    duplicateAnalysis.summary = {
        totalRows: data.length,
        uniqueGuides: guideCounts.size,
        guidesWithDuplicates,
        totalDuplicateRows: totalDuplicates,
        duplicatePercentage: ((totalDuplicates / data.length) * 100).toFixed(2)
    };
    
    duplicateAnalysis.details = Object.fromEntries(duplicatesByCount);
    
    console.timeEnd('Analyzing duplicates');
    return duplicateAnalysis;
}

function generateDuplicationReport() {
    const analysis = analyzeDataDuplication();
    if (!analysis) {
        showNotification('No hay datos para analizar', 'warning');
        return;
    }
    
    const { summary, details } = analysis;
    
    console.log('📊 REPORTE DE DUPLICACIÓN DE GUÍAS:');
    console.log(`🔢 Total de filas: ${summary.totalRows}`);
    console.log(`🎯 Guías únicas: ${summary.uniqueGuides}`);
    console.log(`📋 Guías con duplicados: ${summary.guidesWithDuplicates}`);
    console.log(`❌ Filas duplicadas: ${summary.totalDuplicateRows} (${summary.duplicatePercentage}%)`);
    console.log('');
    
    // Mostrar ejemplos de duplicados más frecuentes
    const sortedDuplicates = Object.entries(details)
        .sort(([a], [b]) => parseInt(b) - parseInt(a))
        .slice(0, 5);
    
    if (sortedDuplicates.length > 0) {
        console.log('🔝 TOP 5 DUPLICADOS MÁS FRECUENTES:');
        sortedDuplicates.forEach(([count, guides]) => {
            console.log(`  ${count} veces: ${guides.slice(0, 3).join(', ')} ${guides.length > 3 ? `(+${guides.length - 3} más)` : ''}`);
        });
    }
    
    // Mostrar notificación al usuario
    showNotification(
        `Análisis completado: ${summary.uniqueGuides} guías únicas de ${summary.totalRows} filas. ${summary.duplicatePercentage}% son duplicados.`,
        'info', 
        5000
    );
    
    return analysis;
}

// --- CONFIGURACIÓN DE IDIOMA LOCAL PARA DATATABLES ---
const dataTablesSpanishConfig = {
    "sProcessing": "Procesando...",
    "sLengthMenu": "Mostrar _MENU_ registros",
    "sZeroRecords": "No se encontraron resultados",
    "sEmptyTable": "Ningún dato disponible en esta tabla",
    "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
    "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
    "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
    "sInfoPostFix": "",
    "sSearch": "Buscar:",
    "sUrl": "",
    "sInfoThousands": ",",
    "sLoadingRecords": "Cargando...",
    "oPaginate": {
        "sFirst": "Primero",
        "sLast": "Último",
        "sNext": "Siguiente",
        "sPrevious": "Anterior"
    },
    "oAria": {
        "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
        "sSortDescending": ": Activar para ordenar la columna de manera descendente"
    },
    "buttons": {
        "copy": "Copiar",
        "colvis": "Visibilidad",
        "collection": "Colección",
        "colvisRestore": "Restaurar visibilidad",
        "copyKeys": "Presione ctrl o u2318 + C para copiar los datos de la tabla al portapapeles del sistema. <br \/> <br \/> Para cancelar, haga clic en este mensaje o presione escape.",
        "copySuccess": {
            "1": "Copiada 1 fila al portapapeles",
            "_": "Copiadas %d filas al portapapeles"
        },
        "copyTitle": "Copiar al portapapeles",
        "csv": "CSV",
        "excel": "Excel",
        "pageLength": {
            "-1": "Mostrar todas las filas",
            "_": "Mostrar %d filas"
        },
        "pdf": "PDF",
        "print": "Imprimir"
    }
};

// --- CONVERSIÓN Y FORMATO DE FECHAS ---
function formatDateForDisplay(date) {
    if (!date) return '';
    
    // Asegurar que sea un objeto Date válido
    const dateObj = date instanceof Date ? date : new Date(date);
    
    // Verificar que la fecha sea válida
    if (isNaN(dateObj.getTime())) return '';
    
    // Formatear como DD/MM/YYYY
    const day = dateObj.getDate().toString().padStart(2, '0');
    const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
    const year = dateObj.getFullYear();
    
    return `${day}/${month}/${year}`;
}

function parseDate(date) {
    if (!date) return '';
    
    // Si es un número (serial de Excel)
    if (typeof date === 'number') {
        // Convertir número serial de Excel a fecha
        // Excel cuenta días desde 1900-01-01 (con ajuste de 2 días por bug histórico)
        const excelEpoch = new Date(1900, 0, 1);
        const msPerDay = 24 * 60 * 60 * 1000;
        const excelDate = new Date(excelEpoch.getTime() + (date - 2) * msPerDay);
        
        if (!isNaN(excelDate.getTime())) {
            return excelDate.toISOString().split('T')[0];
        }
    }
    
    // Si es string, intentar varios formatos
    if (typeof date === 'string') {
        // Limpiar el string
        date = date.trim();
        
        // Formato DD/MM/YYYY o D/M/YYYY
        if (date.includes('/')) {
            const parts = date.split('/');
            if (parts.length === 3) {
                let day = parseInt(parts[0]);
                let month = parseInt(parts[1]);
                let year = parseInt(parts[2]);
                
                // Validar rangos
                if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 1900) {
                    // Crear fecha correcta
                    const parsedDate = new Date(year, month - 1, day);
                    if (!isNaN(parsedDate.getTime())) {
                        return parsedDate.toISOString().split('T')[0];
                    }
                }
            }
        }
        
        // Formato YYYY-MM-DD (ya correcto)
        if (date.includes('-')) {
            const parts = date.split('-');
            if (parts.length === 3 && parts[0].length === 4) {
                const testDate = new Date(date);
                if (!isNaN(testDate.getTime())) {
                    return date;
                }
            }
        }
        
        // Intentar parsear directamente
        const d = new Date(date);
        if (!isNaN(d.getTime())) {
            return d.toISOString().split('T')[0];
        }
    }
    
    console.warn('No se pudo parsear la fecha:', date);
    return '';
}

// --- PROCESAMIENTO DE DATOS ---
function processData() {
    const groupedByDocument = {};
    rawData.forEach(row => {
        row['Producto Cantidad'] = Number(row['Producto Cantidad']) || 0;
        row['Destino Cantidad'] = Number(row['Destino Cantidad']) || 0;
        row['Diferencia de Cantidades'] = Number(row['Diferencia de Cantidades']) || (row['Producto Cantidad'] - row['Destino Cantidad']);
        row['Origen Fecha'] = parseDate(row['Origen Fecha']);
        row['Destino Fecha'] = parseDate(row['Destino Fecha']);
        const doc = row['Origen Documento'];
        if (!groupedByDocument[doc]) groupedByDocument[doc] = [];
        groupedByDocument[doc].push(row);
    });
    processedData = [];
    Object.keys(groupedByDocument).forEach(doc => {
        const group = groupedByDocument[doc];
        let status = 'Aceptado-Total';
        let totalQuantity = 0;
        let totalDestQuantity = 0;
        let anyPartial = false;
        group.forEach(row => {
            totalQuantity += row['Producto Cantidad'];
            totalDestQuantity += row['Destino Cantidad'];
            if (row['Diferencia de Cantidades'] > 0) anyPartial = true;
        });
        if (totalDestQuantity === 0) status = 'Pendiente-Total';
        else if (anyPartial) status = 'Aceptado-Parcial';
        group.forEach(row => {
            row['Estado Documento'] = status;
            processedData.push(row);
        });
    });
}

// --- TABLA GENERAL ---
function initializeTables() {
    if ($.fn.DataTable.isDataTable('#estadoTable')) {
        estadoTable.clear().destroy();
        $('#estadoTable tbody').empty();
    }
    
    // Configuración adaptable basada en el tamaño de datos
    const isLargeDataset = processedData.length > 1000;
    
    // Mostrar loading state específico para tablas grandes
    if (isLargeDataset) {
        showTableSkeleton('#estadoTable');
        showNotification(`Dataset grande detectado (${processedData.length} registros). Activando virtualización para mejor rendimiento.`, 'info');
    }
    
    const tableConfig = {
        dom: 'Bfrtip',
        buttons: [
            'copy', 'csv', 'excel', 'pdf',
            {
                extend: 'print',
                text: 'Imprimir',
                title: 'Resumen de Guías de Transferencia',
                customize: function (win) {
                    $(win.document.body).css('background', '#f6f7fb');
                    $(win.document.body).find('table')
                        .addClass('table-modern')
                        .css('font-size', '0.93rem');
                }
            }
        ],
        scrollX: true,
        deferRender: true,
        processing: true,
        // Configuración condicional para virtualización
        ...(isLargeDataset ? {
            // Para datasets grandes: usar virtualización optimizada
            scrollY: '450px',
            scroller: {
                displayBuffer: processedData.length > 15000 ? 30 : 50, // Buffer dinámico
                boundaryScale: processedData.length > 15000 ? 0.3 : 0.5,
                loadingIndicator: true
            },
            paging: false,
            info: true,
            searching: true,
            // Optimizaciones adicionales para datasets muy grandes
            searchDelay: processedData.length > 15000 ? 500 : 300,
            orderMulti: false, // Deshabilitar ordenamiento múltiple para performance
            stateSave: false, // Deshabilitar guardado de estado para performance
            autoWidth: false
        } : {
            // Para datasets pequeños: paginación tradicional
            scrollY: '400px',
            scrollCollapse: true,
            paging: true,
            pageLength: 50,
            lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "Todos"]]
        }),
        data: [],
        columns: [
            { data: 'Origen Sucursal' },
            { data: 'Origen Almacen' },
            { data: 'Origen Documento' },
            { data: 'Origen Fecha', render: function(data) {
                return data ? formatDateForDisplay(new Date(data)) : '';
            }},
            { data: 'Producto Codigo' },
            { data: 'Producto Descripcion' },
            { data: 'Producto Cantidad' },
            { data: 'Destino Sucursal' },
            { data: 'Destino Almacen' },
            { data: 'Destino Fecha', render: function(data) {
                return data ? formatDateForDisplay(new Date(data)) : '';
            }},
            { data: 'Destino Cantidad' },
            { data: 'Diferencia de Cantidades' },
            { data: 'Estado Documento', render: function(data) {
                let className = '';
                if (data === 'Aceptado-Parcial') className = 'partial';
                else if (data === 'Pendiente-Total') className = 'pending';
                else className = 'completed';
                return `<span class="status-badge ${className}" title="${data}">${data}</span>`;
            }}
        ],
        language: dataTablesSpanishConfig,
        createdRow: function(row, data, dataIndex) {
            const labels = [
                "Sucursal", "Almacén", "Documento", "Fecha", "Código Producto", "Descripción",
                "Cant. Origen", "Sucursal", "Almacén", "Fecha", "Cant. Destino", "Diferencia", "Estado"
            ];
            $('td', row).each(function(i) {
                $(this).attr('data-label', labels[i]);
            });
        }
    };
    
    // Crear la tabla con la configuración adaptable
    estadoTable = $('#estadoTable').DataTable(tableConfig);
    
    // Ocultar skeleton loader si se mostró
    if (isLargeDataset) {
        hideTableSkeleton('#estadoTable');
        
        // Mostrar información sobre virtualización
        setTimeout(() => {
            const info = isLargeDataset ? 
                `Tabla virtualizada: mostrando datos de forma eficiente (${processedData.length} registros totales)` :
                `Tabla con paginación tradicional (${processedData.length} registros)`;
            
            // Agregar tooltip informativo al contenedor de la tabla
            $('#estadoTable_wrapper').attr('title', info);
        }, 500);
    }
    renderEstadoTable();
}

// Versión con debouncing para mejor performance
const renderEstadoTable = debounce(function() {
    if (!estadoTable) return;
    
    // Solo mostrar loading interno si NO viene de cambio de tab reciente
    const isLargeFilter = processedData.length > 5000;
    const isRecentTabChange = (performance.now() - tabChangeTimestamp) < 3000; // 3 segundos
    
    if (isLargeFilter && !isRecentTabChange) {
        showSectionLoading('tablaGeneralTab', 'Aplicando filtros...');
    }
    
    const estadosSeleccionados = $('.estado-filter:checked').map(function() {
        return this.value;
    }).get();
    const soloDiferenteCero = $('#filtroDiferenteCero').is(':checked');
    
    let filtered = processedData.filter(row => estadosSeleccionados.includes(row['Estado Documento']));
    if (soloDiferenteCero) {
        filtered = filtered.filter(row => Number(row['Diferencia de Cantidades']) !== 0);
    }
    
    estadoTable.clear().rows.add(filtered).draw();
    
    // Solo ocultar loading si lo mostramos nosotros
    if (isLargeFilter && !isRecentTabChange) {
        setTimeout(() => {
            hideSectionLoading('tablaGeneralTab');
        }, 200);
    }
    
    // Actualizar gráficos de forma asíncrona
    setTimeout(() => updateCharts(), 10);
}, 300, 'estadoTable');

// Función sin debouncing para uso interno inmediato
function renderEstadoTableImmediate() {
    if (!estadoTable) return;
    const estadosSeleccionados = $('.estado-filter:checked').map(function() {
        return this.value;
    }).get();
    const soloDiferenteCero = $('#filtroDiferenteCero').is(':checked');
    let filtered = processedData.filter(row => estadosSeleccionados.includes(row['Estado Documento']));
    if (soloDiferenteCero) {
        filtered = filtered.filter(row => Number(row['Diferencia de Cantidades']) !== 0);
    }
    estadoTable.clear().rows.add(filtered).draw();
    updateCharts();
}

// --- RESUMEN DE GUÍAS ---
function buildResumenTable() {
    // Validación de entrada
    if (!processedData || !Array.isArray(processedData) || processedData.length === 0) {
        console.warn('buildResumenTable: processedData no válido o vacío');
        return [];
    }
    
    const resumenDocs = {};
    processedData.forEach((row, index) => {
        // Validar que la fila tenga la estructura esperada
        if (!row || typeof row !== 'object') {
            console.warn(`buildResumenTable: Fila ${index} no es un objeto válido:`, row);
            return;
        }
        
        const doc = row['Origen Documento'];
        if (!doc) {
            console.warn(`buildResumenTable: Fila ${index} no tiene 'Origen Documento':`, row);
            return;
        }
        
        if (!resumenDocs[doc]) {
            resumenDocs[doc] = {
                'Almacén Destino': row['Destino Almacen'] || '',
                'Almacén Origen': row['Origen Almacen'] || '',
                'Guía Remisión': doc,
                'Fecha Guía': row['Origen Fecha'] || '',
                'Estado Documento': row['Estado Documento'] || ''
            };
        }
    });
    
    const result = Object.values(resumenDocs);
    console.log('buildResumenTable result:', result.length > 0 ? result[0] : 'empty array');
    return result;
}

function fillResumenFilters(resumenData) {
    // Validación de entrada
    if (!resumenData || !Array.isArray(resumenData) || resumenData.length === 0) {
        console.warn('fillResumenFilters: datos no válidos o vacíos');
        return;
    }
    
    try {
        console.time('fillResumenFilters');
        
        // Extraer datos únicos con validación
        const origenes = [...new Set(
            resumenData
                .map(r => r && r['Almacén Origen'])
                .filter(Boolean)
        )].sort();
        
        const destinos = [...new Set(
            resumenData
                .map(r => r && r['Almacén Destino'])
                .filter(Boolean)
        )].sort();
        
        // Preservar selecciones actuales
        const origenSel = $('#filtroOrigenResumen').val() || "";
        const destinoSel = $('#filtroDestinoResumen').val() || "";
        
        // Actualizar selectores solo si existen en el DOM
        if ($('#filtroOrigenResumen').length) {
            $('#filtroOrigenResumen').html(
                '<option value="">Todos</option>' + 
                origenes.map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('')
            );
            $('#filtroOrigenResumen').val(origenSel);
        }
        
        if ($('#filtroDestinoResumen').length) {
            $('#filtroDestinoResumen').html(
                '<option value="">Todos</option>' + 
                destinos.map(d => `<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join('')
            );
            $('#filtroDestinoResumen').val(destinoSel);
        }
        
        console.timeEnd('fillResumenFilters');
        console.log(`Filtros actualizados: ${origenes.length} orígenes, ${destinos.length} destinos`);
        
    } catch (error) {
        console.error('Error en fillResumenFilters:', error);
    }
}

// Función auxiliar para escapar HTML
function escapeHtml(text) {
    if (typeof text !== 'string') return text;
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function renderResumenTable() {
    // Verificar si es una llamada reciente desde cambio de tab
    const isRecentTabChange = tabChangeTimestamp && (Date.now() - tabChangeTimestamp < 1000);
    
    const resumenData = buildResumenTable();
    
    // Validación de datos del resumen
    if (!resumenData || !Array.isArray(resumenData) || resumenData.length === 0) {
        console.warn('renderResumenTable: No hay datos de resumen para mostrar');
        if ($.fn.DataTable.isDataTable('#resumenTable')) {
            resumenTable.clear().draw();
        }
        return;
    }
    
    const filtroOrigen = $('#filtroOrigenResumen').val() || "";
    const filtroDestino = $('#filtroDestinoResumen').val() || "";
    const filtroEstados = $('#filtroEstadoResumen').val() || [];
    const filtroFechaIni = $('#filtroFechaIniResumen').val();
    const filtroFechaFin = $('#filtroFechaFinResumen').val();
    // Nuevo: filtro por tipo de almacén destino
    const tiposChecked = $('#filtroTipoAlmacen input[type="checkbox"]:checked').map(function() {
        return this.value;
    }).get();
    let filtered = resumenData.filter(row => {
        let ok = true;
        if (filtroOrigen && row['Almacén Origen'] !== filtroOrigen) ok = false;
        if (filtroDestino && row['Almacén Destino'] !== filtroDestino) ok = false;
        if (filtroEstados.length && !filtroEstados.includes(row['Estado Documento'])) ok = false;
        if (filtroFechaIni && row['Fecha Guía'] < filtroFechaIni) ok = false;
        if (filtroFechaFin && row['Fecha Guía'] > filtroFechaFin) ok = false;
        // Filtro por tipo de almacén destino (Almacen/Tienda)
        if (tiposChecked.length > 0) {
            let match = false;
            for (let tipo of tiposChecked) {
                if (row['Almacén Destino'] && row['Almacén Destino'].toLowerCase().startsWith(tipo.toLowerCase())) {
                    match = true;
                    break;
                }
            }
            if (!match) ok = false;
        }
        return ok;
    });
    
    // Validación adicional de estructura de datos filtrados
    console.log('Datos filtrados para resumen:', filtered.length, filtered.length > 0 ? filtered[0] : null);
    
    if ($.fn.DataTable.isDataTable('#resumenTable')) {
        resumenTable.clear().rows.add(filtered).draw();
    } else {
        resumenTable = $('#resumenTable').DataTable({
            dom: 'Bfrtip',
            buttons: [
                'copy', 'csv', 'excel', 'pdf',
                {
                    extend: 'print',
                    text: 'Imprimir', // <-- Cambiado aquí
                    title: 'Resumen de Guías de Transferencia',
                    customize: function (win) {
                        $(win.document.body).css('background', '#f6f7fb');
                        $(win.document.body).find('table')
                            .addClass('table-modern')
                            .css('font-size', '0.93rem');
                    }
                }
            ],
            scrollX: true,
            scrollY: '300px',
            scrollCollapse: true,
            paging: true,
            pageLength: 20,
            deferRender: true,
            data: filtered,
            columns: [
                { 
                    data: 'Almacén Destino',
                    defaultContent: '',
                    render: function(data, type, row) {
                        return data || '';
                    }
                },
                { 
                    data: 'Almacén Origen',
                    defaultContent: '',
                    render: function(data, type, row) {
                        return data || '';
                    }
                },
                { 
                    data: 'Guía Remisión', 
                    defaultContent: '',
                    render: function(data, type, row) {
                        if (!data) return '';
                        return `<a href="#" class="ver-detalle-guia" data-guia="${data}" title="Ver detalle de la guía">${data}</a>`;
                    }
                },
                { 
                    data: 'Fecha Guía', 
                    defaultContent: '',
                    render: function(data, type, row) {
                        if (!data) return '';
                        try {
                            return formatDateForDisplay(new Date(data));
                        } catch (e) {
                            console.warn('Error formateando fecha:', data, e);
                            return data || '';
                        }
                    }
                },
                { 
                    data: 'Estado Documento', 
                    defaultContent: '',
                    render: function(data, type, row) {
                        if (!data) return '';
                        let className = '';
                        if (data === 'Aceptado-Parcial') className = 'partial';
                        else if (data === 'Pendiente-Total') className = 'pending';
                        else className = 'completed';
                        return `<span class="status-badge ${className}" title="${data}">${data}</span>`;
                    }
                }
            ],
            language: dataTablesSpanishConfig
        });
    }
    fillResumenFilters(resumenData);
}

// --- GRÁFICOS CON LOADING STATES MEJORADOS ---
function updateKPIs() {
    if (!processedData || processedData.length === 0) return;
    
    console.time('updateKPIs');
    
    // Usar la nueva función optimizada que elimina duplicados
    const metrics = calculateMetricsOptimized(processedData);
    
    // Destructuring para mayor claridad
    const { 
        totalGuias, 
        completas, 
        parciales, 
        pendientes,
        completasPercent,
        parcialesPercent, 
        pendientesPercent 
    } = metrics;
    
    // Actualizar valores principales con animación
    animateValue('totalGuias', 0, totalGuias, 1000);
    animateValue('guiasCompletas', 0, completas, 1200);
    animateValue('guiasParciales', 0, parciales, 1400);
    animateValue('guiasPendientes', 0, pendientes, 1600);
    
    // Actualizar porcentajes
    setTimeout(() => {
        $('#completasPercent').text(completasPercent + '%');
        $('#parcialesPercent').text(parcialesPercent + '%');
        $('#pendientesPercent').text(pendientesPercent + '%');
    }, 800);
    
    // Calcular métricas adicionales
    const almacenes = [...new Set(processedData.map(row => row['Almacén Destino']))].length;
    const fechas = processedData.map(row => new Date(row['Fecha Origen'])).sort();
    const fechaMin = fechas[0];
    const fechaMax = fechas[fechas.length - 1];
    
    // Actualizar métricas adicionales
    setTimeout(() => {
        $('#totalAlmacenes').text(almacenes);
        
        if (fechaMin && fechaMax) {
            const rangoTexto = formatDateForDisplay(fechaMin) + ' - ' + formatDateForDisplay(fechaMax);
            $('#rangoFechas').text(rangoTexto);
        }
        
        $('#ultimaActualizacion').text(formatDateForDisplay(new Date()) + ' ' + new Date().toLocaleTimeString());
    }, 1000);
    
    // Agregar indicadores de tendencia (ejemplo)
    const eficiencia = ((completas / totalGuias) * 100);
    const trendElement = $('#guiasTrend');
    if (eficiencia > 70) {
        trendElement.html('<i class="bi bi-trending-up"></i> Excelente').addClass('trend-up').removeClass('trend-down');
    } else if (eficiencia > 50) {
        trendElement.html('<i class="bi bi-dash"></i> Regular').removeClass('trend-up trend-down');
    } else {
        trendElement.html('<i class="bi bi-trending-down"></i> Necesita atención').addClass('trend-down').removeClass('trend-up');
    }
    
    console.timeEnd('updateKPIs');
    debugLog(`✅ KPIs actualizados - ${totalGuias} guías únicas de ${processedData.length} filas totales`);
}

function animateValue(elementId, start, end, duration) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const range = Math.abs(end - start);
    
    // Optimización: Para valores grandes, usar duración fija y incrementos dinámicos
    let optimizedDuration = duration;
    let steps = 60; // Número fijo de pasos para suavidad
    
    // Si el valor es muy grande (>10k), reducir duración para evitar esperas largas
    if (range > 10000) {
        optimizedDuration = Math.min(duration, 2000); // Máximo 2 segundos
        steps = 40; // Menos pasos para valores muy grandes
    } else if (range > 1000) {
        optimizedDuration = Math.min(duration, 1500); // Máximo 1.5 segundos
        steps = 50;
    }
    
    const stepTime = optimizedDuration / steps;
    const increment = range / steps;
    
    let current = start;
    let stepCount = 0;
    
    // Usar requestAnimationFrame para mejor rendimiento
    const animate = () => {
        stepCount++;
        
        if (stepCount <= steps) {
            // Usar easing para que se vea más natural
            const progress = stepCount / steps;
            const easedProgress = 1 - Math.pow(1 - progress, 3); // easeOutCubic
            current = start + (range * easedProgress * (end >= start ? 1 : -1));
            
            element.textContent = Math.floor(current).toLocaleString();
            
            setTimeout(() => requestAnimationFrame(animate), stepTime);
        } else {
            // Asegurar valor final exacto
            element.textContent = end.toLocaleString();
        }
    };
    
    requestAnimationFrame(animate);
}

// Paletas de colores mejoradas
const chartColors = {
    primary: {
        background: ['rgba(0, 123, 255, 0.1)', 'rgba(0, 123, 255, 0.2)', 'rgba(0, 123, 255, 0.3)'],
        border: ['rgba(0, 123, 255, 1)', 'rgba(0, 123, 255, 0.8)', 'rgba(0, 123, 255, 0.6)'],
        gradient: ['#007bff', '#0056b3']
    },
    success: {
        background: ['rgba(40, 167, 69, 0.1)', 'rgba(40, 167, 69, 0.2)', 'rgba(40, 167, 69, 0.3)'],
        border: ['rgba(40, 167, 69, 1)', 'rgba(40, 167, 69, 0.8)', 'rgba(40, 167, 69, 0.6)'],
        gradient: ['#28a745', '#155724']
    },
    warning: {
        background: ['rgba(255, 193, 7, 0.1)', 'rgba(255, 193, 7, 0.2)', 'rgba(255, 193, 7, 0.3)'],
        border: ['rgba(255, 193, 7, 1)', 'rgba(255, 193, 7, 0.8)', 'rgba(255, 193, 7, 0.6)'],
        gradient: ['#ffc107', '#e0a800']
    },
    danger: {
        background: ['rgba(220, 53, 69, 0.1)', 'rgba(220, 53, 69, 0.2)', 'rgba(220, 53, 69, 0.3)'],
        border: ['rgba(220, 53, 69, 1)', 'rgba(220, 53, 69, 0.8)', 'rgba(220, 53, 69, 0.6)'],
        gradient: ['#dc3545', '#c82333']
    },
    professional: [
        'rgba(102, 126, 234, 0.8)',
        'rgba(118, 75, 162, 0.8)', 
        'rgba(255, 193, 7, 0.8)',
        'rgba(220, 53, 69, 0.8)',
        'rgba(40, 167, 69, 0.8)',
        'rgba(23, 162, 184, 0.8)',
        'rgba(108, 117, 125, 0.8)',
        'rgba(255, 107, 107, 0.8)'
    ],
    professionalBorder: [
        'rgba(102, 126, 234, 1)',
        'rgba(118, 75, 162, 1)', 
        'rgba(255, 193, 7, 1)',
        'rgba(220, 53, 69, 1)',
        'rgba(40, 167, 69, 1)',
        'rgba(23, 162, 184, 1)',
        'rgba(108, 117, 125, 1)',
        'rgba(255, 107, 107, 1)'
    ]
};

// Configuraciones globales mejoradas para Chart.js
const chartDefaults = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            position: 'bottom',
            labels: {
                padding: 20,
                usePointStyle: true,
                font: {
                    size: 12,
                    weight: '500'
                }
            }
        },
        tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: 'white',
            bodyColor: 'white',
            borderColor: 'rgba(255, 255, 255, 0.2)',
            borderWidth: 1,
            cornerRadius: 8,
            padding: 12,
            titleFont: {
                size: 14,
                weight: 'bold'
            },
            bodyFont: {
                size: 12
            }
        }
    },
    animation: {
        duration: 1500,
        easing: 'easeInOutQuart'
    }
};

function updateCharts() {
    // Actualizar KPIs primero
    updateKPIs();
    
    // Los gráficos ahora usan el Advanced Loading Overlay System aplicado al dashboardTab
    // No se requieren loading states individuales por gráfico
    
    // Procesar datos con retraso para mostrar loading
    setTimeout(() => {
        try {
            const estadosSeleccionados = $('.estado-filter:checked').map(function() {
                return this.value;
            }).get();
            
            const filtered = processedData.filter(row => estadosSeleccionados.includes(row['Estado Documento']));
            
            // Procesar estados
            const statusCounts = { 'Aceptado-Total': 0, 'Aceptado-Parcial': 0, 'Pendiente-Total': 0 };
            const uniqueDocs = {};
            
            filtered.forEach(function(row) {
                const doc = row['Origen Documento'];
                if (!uniqueDocs[doc]) {
                    uniqueDocs[doc] = row['Estado Documento'];
                    statusCounts[row['Estado Documento']]++;
                }
            });
            
            // Actualizar gráfico de estados
            updateStatusChart(statusCounts);
            
            // Procesar almacenes con retraso
            setTimeout(() => {
                updateWarehouseChart(filtered, uniqueDocs);
            }, 100);
            
            // Procesar fechas con retraso
            setTimeout(() => {
                updateDateChart(filtered, uniqueDocs);
            }, 200);
            
        } catch (error) {
            console.error('Error actualizando gráficos:', error);
            // El loading se maneja a nivel de dashboardTab por el Advanced Loading Overlay System
        }
    }, 50);
}

// Función específica para actualizar gráfico de estados
function updateStatusChart(statusCounts) {
    const statusChartData = {
        labels: ['Aceptado-Total', 'Aceptado-Parcial', 'Pendiente-Total'],
        datasets: [{
            data: [statusCounts['Aceptado-Total'], statusCounts['Aceptado-Parcial'], statusCounts['Pendiente-Total']],
            backgroundColor: ['rgba(40, 167, 69, 0.2)', 'rgba(255, 193, 7, 0.2)', 'rgba(220, 53, 69, 0.2)'],
            borderColor: ['rgba(40, 167, 69, 1)', 'rgba(255, 193, 7, 1)', 'rgba(220, 53, 69, 1)'],
            borderWidth: 2
        }]
    };
    
    if (statusChart) statusChart.destroy();
    // Aplicar paleta profesional al gráfico de estados
    statusChartData.datasets[0].backgroundColor = [
        chartColors.success.background[0],  // Aceptado-Total
        chartColors.warning.background[0],  // Aceptado-Parcial
        chartColors.danger.background[0]    // Pendiente-Total
    ];
    statusChartData.datasets[0].borderColor = [
        chartColors.success.border[0],
        chartColors.warning.border[0],
        chartColors.danger.border[0]
    ];
    statusChartData.datasets[0].borderWidth = 3;
    statusChartData.datasets[0].hoverBorderWidth = 4;

    statusChart = new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: statusChartData,
        options: {
            ...chartDefaults,
            cutout: '60%',
            onHover: (event, activeElements) => {
                event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
            },
            onClick: (event, activeElements) => {
                if (activeElements.length > 0) {
                    const dataIndex = activeElements[0].index;
                    const label = statusChartData.labels[dataIndex];
                    drillDownStatus(label);
                }
            },
            plugins: {
                ...chartDefaults.plugins,
                legend: {
                    ...chartDefaults.plugins.legend,
                    position: 'bottom',
                    onHover: (event, legendItem) => {
                        event.native.target.style.cursor = 'pointer';
                    },
                    onClick: (event, legendItem) => {
                        drillDownStatus(legendItem.text);
                    }
                },
                tooltip: {
                    ...chartDefaults.plugins.tooltip,
                    callbacks: {
                        label: function(context) {
                            const percentage = ((context.raw / context.dataset.data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                            return `${context.label}: ${context.raw} guías (${percentage}%)`;
                        },
                        afterLabel: function(context) {
                            return 'Haz clic para ver detalles';
                        }
                    }
                }
            }
        }
    });
}

// Función específica para actualizar gráfico de almacenes  
function updateWarehouseChart(filtered, uniqueDocs) {
    const warehouseDocs = {};
    Object.keys(uniqueDocs).forEach(function(doc) {
        const estado = uniqueDocs[doc];
        if (estado !== 'Aceptado-Total') {
            const row = filtered.find(r => r['Origen Documento'] === doc);
            const warehouse = row ? (row['Destino Almacen'] || 'Sin Almacén') : 'Sin Almacén';
            if (!warehouseDocs[warehouse]) warehouseDocs[warehouse] = 0;
            warehouseDocs[warehouse]++;
        }
    });
    
    const sortedWarehouses = Object.keys(warehouseDocs).sort((a, b) => warehouseDocs[b] - warehouseDocs[a]);
    const warehouseNumbers = sortedWarehouses.map((w, i) => i + 1);
    
    const warehouseChartData = {
        labels: warehouseNumbers.map(n => n.toString()),
        datasets: [{
            label: 'Guías Pendientes',
            data: sortedWarehouses.map(w => warehouseDocs[w]),
            backgroundColor: chartColors.primary.background[0],
            borderColor: chartColors.primary.border[0],
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            pointBackgroundColor: chartColors.primary.border[0],
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8
        }]
    };
    
    // Actualizar o crear gráfico
    if (warehouseChart) warehouseChart.destroy();
    warehouseChart = new Chart(document.getElementById('warehouseChart'), {
        type: 'line',
        data: warehouseChartData,
        options: {
            ...chartDefaults,
            plugins: {
                ...chartDefaults.plugins,
                legend: { display: false },
                tooltip: {
                    ...chartDefaults.plugins.tooltip,
                    callbacks: {
                        label: function(context) {
                            const warehouseName = sortedWarehouses[context.dataIndex];
                            return `${warehouseName}: ${context.raw} guías pendientes`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true, 
                    title: { display: true, text: 'Guías Pendientes' },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: { 
                    title: { display: true, text: 'Almacenes (ordenados por cantidad)' },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    
    // Actualizar leyenda
    let legendHtml = '<table class="warehouse-legend-table"><thead><tr><th>#</th><th>Almacén</th><th>Pendientes</th></tr></thead><tbody>';
    sortedWarehouses.forEach(function(w, i) {
        legendHtml += `<tr><td>${i + 1}</td><td title="${w}">${w}</td><td>${warehouseDocs[w]}</td></tr>`;
    });
    legendHtml += '</tbody></table>';
    $('#warehouseLegend').html(legendHtml);
}

// Función específica para actualizar gráfico de fechas
function updateDateChart(filtered, uniqueDocs) {
    const dateDocs = {};
    
    // Filtrar solo documentos pendientes para el gráfico de fechas
    Object.keys(uniqueDocs).forEach(function(doc) {
        const estado = uniqueDocs[doc];
        if (estado !== 'Aceptado-Total') {
            const row = filtered.find(r => r['Origen Documento'] === doc);
            if (row) {
                const date = row['Origen Fecha'];
                if (!dateDocs[date]) dateDocs[date] = 0;
                dateDocs[date]++;
            }
        }
    });
    
    const sortedDates = Object.keys(dateDocs).sort((a, b) => new Date(a) - new Date(b));
    const dateChartData = {
        labels: sortedDates.map(d => formatDateForDisplay(new Date(d))),
        datasets: [{
            label: 'Guías Pendientes por Fecha',
            data: sortedDates.map(d => dateDocs[d]),
            backgroundColor: chartColors.danger.background[0],
            borderColor: chartColors.danger.border[0],
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            pointBackgroundColor: chartColors.danger.border[0],
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 8
        }]
    };
    
    // Actualizar o crear gráfico
    if (dateChart) dateChart.destroy();
    dateChart = new Chart(document.getElementById('dateChart'), {
        type: 'line',
        data: dateChartData,
        options: {
            ...chartDefaults,
            plugins: {
                ...chartDefaults.plugins,
                legend: { display: false },
                tooltip: {
                    ...chartDefaults.plugins.tooltip,
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.raw} guías pendientes`;
                        },
                        title: function(context) {
                            return formatDateForDisplay(new Date(sortedDates[context[0].dataIndex]));
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true, 
                    title: { display: true, text: 'Guías Pendientes' },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: { 
                    title: { display: true, text: 'Fecha de Origen' },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// --- FUNCIONES DE DRILL-DOWN INTERACTIVO ---
function drillDownStatus(estado) {
    // Filtrar datos por estado seleccionado
    const filteredData = processedData.filter(row => row['Estado Documento'] === estado);
    
    // Obtener guías únicas para estadísticas correctas
    const uniqueFilteredData = getUniqueGuides(filteredData);
    
    // Crear modal con información detallada
    const modalHtml = `
        <div class="modal fade" id="drillDownModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-graph-up me-2"></i>
                            Detalle: ${estado}
                        </h5>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Cerrar
                            </button>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="stat-card text-center">
                                    <h3 class="text-primary">${uniqueFilteredData.length}</h3>
                                    <p class="mb-0">Guías Únicas</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card text-center">
                                    <h3 class="text-secondary">${filteredData.length}</h3>
                                    <p class="mb-0">Total Filas</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-card text-center">
                                    <h3 class="text-info">${new Set(filteredData.map(r => r['Almacén Destino'])).size}</h3>
                                    <p class="mb-0">Almacenes Únicos</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-card text-center">
                                    <h3 class="text-warning">${new Set(filteredData.map(r => r['Fecha Origen'])).size}</h3>
                                    <p class="mb-0">Fechas Únicas</p>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped" id="drillDownTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Guía</th>
                                        <th>Almacén Origen</th>
                                        <th>Almacén Destino</th>
                                        <th>Fecha</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredData.slice(0, 100).map(row => `
                                        <tr>
                                            <td><strong>${row['Origen Documento']}</strong></td>
                                            <td>${row['Almacén Origen']}</td>
                                            <td>${row['Almacén Destino']}</td>
                                            <td>${formatDateForDisplay(new Date(row['Fecha Origen']))}</td>
                                            <td><span class="badge bg-${getStatusColor(row['Estado Documento'])}">${row['Estado Documento']}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ${filteredData.length > 100 ? `<p class="text-muted small">Mostrando las primeras 100 de ${filteredData.length} guías</p>` : ''}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-primary" onclick="exportDrillDown('${estado}')">
                            <i class="bi bi-download me-2"></i>Exportar Datos
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Limpiar modales anteriores usando la función global
    clearBlockedModals();
    
    // Pausa para asegurar limpieza completa antes de crear nuevo modal
    setTimeout(() => {
        // Verificar que no hay otros modales antes de agregar el nuevo
        if ($('#drillDownModal').length > 0) {
            $('#drillDownModal').remove();
        }
        
        // Agregar nuevo modal
        $('body').append(modalHtml);
    
        // Configurar eventos del modal antes de mostrarlo
        const modalElement = document.getElementById('drillDownModal');
        const modal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    
    // Event listeners para limpiar correctamente al cerrar
    modalElement.addEventListener('hidden.bs.modal', function () {
        setTimeout(() => {
            // Destruir DataTable si existe
            if ($.fn.DataTable.isDataTable('#drillDownTable')) {
                $('#drillDownTable').DataTable().destroy();
            }
            
            // Limpiar modal completamente
            $(this).remove();
            
            // Asegurar limpieza completa del backdrop y estado del body
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open modal-scrollbar-measure');
            $('body').css({
                'overflow': '',
                'padding-right': '',
                'position': '',
                'top': ''
            });
            
            // Remover event listeners huérfanos
            $(document).off('keydown.bs.modal');
            
        }, 50);
    });
    
    // Mostrar modal
    modal.show();
    
    // Inicializar DataTable después de que el modal esté visible
    modalElement.addEventListener('shown.bs.modal', function () {
        try {
            if (!$.fn.DataTable.isDataTable('#drillDownTable')) {
                $('#drillDownTable').DataTable({
                    language: dataTablesSpanishConfig,
                    pageLength: 25,
                    responsive: true,
                    dom: 'Bfrtip',
                    buttons: ['copy', 'csv', 'excel', 'pdf'],
                    destroy: true // Permite recrear la tabla si ya existe
                });
            }
        } catch (error) {
            console.warn('Error inicializando DataTable:', error);
        }
    });
    }, 100); // Cerrar el setTimeout que se abrió anteriormente
}

function getStatusColor(status) {
    switch(status) {
        case 'Aceptado-Total': return 'success';
        case 'Aceptado-Parcial': return 'warning';
        case 'Pendiente-Total': return 'danger';
        default: return 'secondary';
    }
}

function exportDrillDown(estado) {
    const filteredData = processedData.filter(row => row['Estado Documento'] === estado);
    
    // Crear CSV
    const headers = ['Guía', 'Almacén Origen', 'Almacén Destino', 'Fecha Origen', 'Estado'];
    const csvContent = [
        headers.join(','),
        ...filteredData.map(row => [
            row['Origen Documento'],
            row['Almacén Origen'],
            row['Almacén Destino'],
            formatDateForDisplay(new Date(row['Fecha Origen'])),
            row['Estado Documento']
        ].join(','))
    ].join('\n');
    
    // Descargar archivo
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `detalle_${estado.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

function refreshDashboard() {
    // Mostrar indicador de carga
    $('.dashboard-actions button').prop('disabled', true);
    $('.dashboard-actions .btn i').addClass('fa-spin');
    
    // Remover vibración y resaltar ya que el usuario está actualizando
    const refreshBtn = $('#refreshDashboardBtn');
    refreshBtn.removeClass('btn-vibrate btn-outline-warning').addClass('btn-outline-light');
    refreshBtn.attr('title', 'Actualizar datos del dashboard');
    refreshBtn.attr('data-bs-original-title', 'Actualizar datos del dashboard');
    
    // Restaurar icono original si estaba cambiado
    const icon = refreshBtn.find('i');
    icon.removeClass('bi-exclamation-triangle').addClass('bi-arrow-clockwise');
    
    // Simular actualización (en caso real sería una nueva carga de datos)
    setTimeout(() => {
        updateKPIs();
        updateCharts();
        
        // Restaurar botones
        $('.dashboard-actions button').prop('disabled', false);
        $('.dashboard-actions .btn i').removeClass('fa-spin');
        
        // Mostrar notificación de éxito
        showNotification('Dashboard actualizado correctamente', 'success');
    }, 1500);
}

function exportDashboard() {
    if (!processedData || processedData.length === 0) {
        showNotification('No hay datos para exportar', 'warning');
        return;
    }
    
    // Usar métricas optimizadas que eliminan duplicados
    console.time('Export Dashboard');
    const metrics = calculateMetricsOptimized(processedData);
    const { totalGuias, completas, parciales, pendientes, completasPercent, parcialesPercent, pendientesPercent } = metrics;
    
    const resumen = [
        ['RESUMEN DASHBOARD DE TRANSFERENCIAS'],
        ['Fecha de generación:', formatDateForDisplay(new Date()) + ' ' + new Date().toLocaleTimeString()],
        [''],
        ['MÉTRICAS PRINCIPALES (GUÍAS ÚNICAS)'],
        ['Total de Guías Únicas:', totalGuias],
        ['Total de Filas de Datos:', processedData.length],
        ['Guías Completas:', completas, `(${completasPercent}%)`],
        ['Guías Parciales:', parciales, `(${parcialesPercent}%)`],
        ['Guías Pendientes:', pendientes, `(${pendientesPercent}%)`],
        [''],
        ['ALMACENES ÚNICOS:', new Set(processedData.map(r => r['Almacén Destino'])).size],
        ['RANGO DE FECHAS:', 
            formatDateForDisplay(new Date(Math.min(...processedData.map(r => new Date(r['Fecha Origen']))))),
            'a',
            formatDateForDisplay(new Date(Math.max(...processedData.map(r => new Date(r['Fecha Origen'])))))
        ]
    ];
    
    const csvContent = resumen.map(row => row.join(',')).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `resumen_dashboard_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    
    console.timeEnd('Export Dashboard');
    showNotification(`Resumen exportado - ${totalGuias} guías únicas de ${processedData.length} filas`, 'success');
}

// --- DETALLE DE GUÍA ---
$(document).on('click', '.ver-detalle-guia', function(e) {
    e.preventDefault();
    const guia = $(this).data('guia');
    const fila = processedData.find(row => row['Origen Documento'] === guia);
    let info = '';
    if (fila) {
        info = `Almacén Origen: <b>${fila['Origen Almacen']}</b> &nbsp; | &nbsp; Almacén Destino: <b>${fila['Destino Almacen']}</b> &nbsp; | &nbsp; Fecha Origen: <b>${formatDateForDisplay(new Date(fila['Origen Fecha']))}</b>`;
    }
    $('#detalleGuiaModal').data('guia', guia);
    $('#detalleGuiaLabel').text('Detalle de Guía: ' + guia);
    $('#detalleGuiaInfo').html(info);
    $('input[name="detalleFiltro"][value="todo"]').prop('checked', true);
    cargarDetalleGuia(guia, 'todo');

    // Si está en pantalla completa, sube el z-index del modal y backdrop
    if (resumenFullscreenActivo) {
        $('#detalleGuiaModal').appendTo('body').modal('show');
        setTimeout(function() {
            $('.modal-backdrop').last().css('z-index', 1070);
            $('#detalleGuiaModal').css('z-index', 1071);
        }, 100);
    } else {
        $('#detalleGuiaModal').modal('show');
    }
});
$(document).on('change', 'input[name="detalleFiltro"]', function() {
    const guia = $('#detalleGuiaModal').data('guia');
    const filtro = $('input[name="detalleFiltro"]:checked').val();
    cargarDetalleGuia(guia, filtro);
});
function cargarDetalleGuia(guia, filtro) {
    let filas = processedData.filter(row => row['Origen Documento'] === guia);
    if (filtro === 'pendiente') {
        filas = filas.filter(row => Number(row['Diferencia de Cantidades']) > 0);
    }
        let html = '';
    if (filas.length === 0) {
        html = '<tr><td colspan="5" class="text-center">Sin datos</td></tr>';
    } else {
        filas.forEach(row => {
            html += `<tr>
                <td data-label="Producto Código">${row['Producto Codigo']}</td>
                <td data-label="Producto Descripción">${row['Producto Descripcion']}</td>
                <td data-label="Cantidad Origen">${row['Producto Cantidad']}</td>
                <td data-label="Cantidad Destino">${row['Destino Cantidad']}</td>
                <td data-label="Diferencia">${row['Diferencia de Cantidades']}</td>
            </tr>`;
        });
    }
    $('#detalleGuiaTable tbody').html(html);
}

// --- ZOOM SOLO EN PANTALLA COMPLETA ---
function setFullscreenTableFontSize(percent) {
    // Solo afecta la tabla dentro de #resumenFullscreenTableWrapper
    $('#resumenFullscreenTableWrapper table, #resumenFullscreenTableWrapper th, #resumenFullscreenTableWrapper td')
        .css('font-size', (percent / 100) + 'em');
}
$('#zoomBar').on('input change', function() {
    const val = $(this).val();
    $('#zoomValue').text(val + '%');
    setFullscreenTableFontSize(val);
});
// Al abrir pantalla completa, restablece zoom
$('#btnResumenFullscreen').on('click', function() {
    $('#zoomBar').val(100);
    $('#zoomValue').text('100%');
    setFullscreenTableFontSize(100);
});
// Al cerrar, limpia cualquier cambio
function cerrarPantallaCompletaResumen() {
    if (!resumenFullscreenActivo) return;
    resumenFullscreenActivo = false;
    $('#resumenFullscreenTableWrapper').html('');
    $('#resumenFullscreenOverlay').fadeOut(120);
    $('body').css('overflow', '');
    // Limpia zoom
    $('#zoomBar').val(100);
    $('#zoomValue').text('100%');
}

// --- EXPORTAR DETALLE COMPLETO EN EXCEL DESDE PANTALLA COMPLETA ---
$('#btnExportarExcelFullscreen').off('click').on('click', function() {
    if (!resumenFullscreenActivo) return;

    // Modal simple para elegir tipo de exportación
    const modalHtml = `
      <div id="modalExportarExcel" style="position:fixed;z-index:30000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);display:flex;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:32px 24px;border-radius:12px;box-shadow:0 4px 32px rgba(0,32,96,0.13);min-width:320px;text-align:center;">
          <div style="font-size:1.1rem;margin-bottom:18px;">¿Qué desea descargar?</div>
          <button id="btnExportarTodo" class="btn btn-success me-3"><span class="bi bi-file-earmark-spreadsheet"></span> Todo</button>
          <button id="btnExportarPendientes" class="btn btn-warning"><span class="bi bi-exclamation-circle"></span> Solo pendientes</button>
          <br><button id="btnCancelarExportar" class="btn btn-link mt-3">Cancelar</button>
        </div>
      </div>
    `;
    $('body').append(modalHtml);

    $('#btnExportarTodo').on('click', function() {
        exportarExcelDetalle('todo');
        $('#modalExportarExcel').remove();
    });
    $('#btnExportarPendientes').on('click', function() {
        exportarExcelDetalle('pendiente');
        $('#modalExportarExcel').remove();
    });
    $('#btnCancelarExportar').on('click', function() {
        $('#modalExportarExcel').remove();
    });
});

function exportarExcelDetalle(tipo) {
    // Obtén los filtros activos en la pantalla completa
    const resumenData = buildResumenTable();
    const filtroOrigen = $('#filtroOrigenResumen').val() || "";
    const filtroDestino = $('#filtroDestinoResumen').val() || "";
    const filtroEstados = $('#filtroEstadoResumen').val() || [];
    const filtroFechaIni = $('#filtroFechaIniResumen').val();
    const filtroFechaFin = $('#filtroFechaFinResumen').val();
    const tiposChecked = $('#filtroTipoAlmacen input[type="checkbox"]:checked').map(function() {
        return this.value;
    }).get();

    // Filtra los documentos igual que en renderResumenTable
    let docsFiltrados = resumenData.filter(row => {
        let ok = true;
        if (filtroOrigen && row['Almacén Origen'] !== filtroOrigen) ok = false;
        if (filtroDestino && row['Almacén Destino'] !== filtroDestino) ok = false;
        if (filtroEstados.length && !filtroEstados.includes(row['Estado Documento'])) ok = false;
        if (filtroFechaIni && row['Fecha Guía'] < filtroFechaIni) ok = false;
        if (filtroFechaFin && row['Fecha Guía'] > filtroFechaFin) ok = false;
        if (tiposChecked.length > 0) {
            let match = false;
            for (let tipo of tiposChecked) {
                if (row['Almacén Destino'] && row['Almacén Destino'].toLowerCase().startsWith(tipo.toLowerCase())) {
                    match = true;
                    break;
                }
            }
            if (!match) ok = false;
        }
        return ok;
    }).map(row => row['Guía Remisión']);

    // Filtra los detalles de las guías seleccionadas
    let filas = processedData.filter(row => docsFiltrados.includes(row['Origen Documento']));
    if (tipo === 'pendiente') {
        filas = filas.filter(row => Number(row['Diferencia de Cantidades']) > 0);
    }

    if (!filas.length) {
        alert('No hay datos para exportar.');
        return;
    }

    // Prepara los datos para Excel
    const headers = [
        "Origen Sucursal", "Origen Almacen", "Origen Documento", "Origen Fecha",
        "Producto Codigo", "Producto Descripcion", "Producto Cantidad",
        "Destino Sucursal", "Destino Almacen", "Destino Fecha", "Destino Cantidad",
        "Diferencia de Cantidades", "Estado Documento"
    ];
    const data = [headers];
    filas.forEach(row => {
        data.push([
            row["Origen Sucursal"], row["Origen Almacen"], row["Origen Documento"], 
            row["Origen Fecha"] ? formatDateForDisplay(new Date(row["Origen Fecha"])) : '',
            row["Producto Codigo"], row["Producto Descripcion"], row["Producto Cantidad"],
            row["Destino Sucursal"], row["Destino Almacen"], 
            row["Destino Fecha"] ? formatDateForDisplay(new Date(row["Destino Fecha"])) : '', 
            row["Destino Cantidad"], row["Diferencia de Cantidades"], row["Estado Documento"]
        ]);
    });

    // Genera y descarga el archivo Excel
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Detalle");
    XLSX.writeFile(wb, "Detalle_Guias.xlsx");
}

// Modal de detalle de guía: siempre encima
$(document).on('click', '.ver-detalle-guia', function(e) {
    e.preventDefault();
    const guia = $(this).data('guia');
    const fila = processedData.find(row => row['Origen Documento'] === guia);
    let info = '';
    if (fila) {
        info = `Almacén Origen: <b>${fila['Origen Almacen']}</b> &nbsp; | &nbsp; Almacén Destino: <b>${fila['Destino Almacen']}</b> &nbsp; | &nbsp; Fecha Origen: <b>${formatDateForDisplay(new Date(fila['Origen Fecha']))}</b>`;
    }
    $('#detalleGuiaModal').data('guia', guia);
    $('#detalleGuiaLabel').text('Detalle de Guía: ' + guia);
    $('#detalleGuiaInfo').html(info);
    $('input[name="detalleFiltro"][value="todo"]').prop('checked', true);
    cargarDetalleGuia(guia, 'todo');
    $('#detalleGuiaModal').appendTo('body').modal('show');
});

// --- FUNCIONES DE INICIALIZACIÓN Y MEJORAS ADICIONALES ---
function initializeTooltips() {
    // Mejorar tooltips con mejor posicionamiento
    $(document).on('mouseenter', '.tooltip-custom', function() {
        const $tooltip = $(this).find('.tooltip-text');
        if ($tooltip.length) {
            // Ajustar posición si el tooltip se sale de la pantalla
            const tooltipRect = $tooltip[0].getBoundingClientRect();
            const windowWidth = window.innerWidth;
            
            if (tooltipRect.right > windowWidth) {
                $tooltip.css('left', 'auto').css('right', '0');
            }
        }
    });
    
    // Tooltips dinámicos para elementos DataTables
    $(document).on('mouseenter', '.dataTables_wrapper .dt-buttons .btn', function() {
        const btnText = $(this).text().trim();
        let tooltipText = '';
        
        switch(btnText.toLowerCase()) {
            case 'copy':
                tooltipText = 'Copiar datos al portapapeles';
                break;
            case 'csv':
                tooltipText = 'Exportar como archivo CSV';
                break;
            case 'excel':
                tooltipText = 'Exportar como archivo Excel';
                break;
            case 'pdf':
                tooltipText = 'Exportar como archivo PDF';
                break;
            case 'imprimir':
                tooltipText = 'Imprimir tabla con formato optimizado';
                break;
        }
        
        if (tooltipText && !$(this).attr('title')) {
            $(this).attr('title', tooltipText);
        }
    });
}

function initializePerformanceMonitoring() {
    // Monitorear el rendimiento de las tablas grandes
    let performanceMetrics = {
        loadTimes: [],
        filterTimes: [],
        renderTimes: []
    };
    
    // Exponer métricas para debugging
    window.getPerformanceMetrics = () => performanceMetrics;
    
    // Detectar datasets grandes y mostrar recomendaciones
    if (typeof processedData !== 'undefined' && processedData.length > 5000) {
        setTimeout(() => {
            showNotification(`Dataset grande detectado (${processedData.length} registros). Las mejoras de performance están activas.`, 'info', 4000);
        }, 2000);
    }
}

// --- OPTIMIZACIÓN DE CAMBIOS DE MÓDULO ---
let tabChangeTimeout;
let currentTab = 'dashboardTab';

function optimizeTabChange(targetTab) {
    // Debounce para evitar cambios demasiado rápidos
    clearTimeout(tabChangeTimeout);
    
    // Si ya estamos en este tab, no hacer nada
    if (currentTab === targetTab) return;
    
    const tabName = targetTab.replace('Tab', '');
    const dataSize = typeof processedData !== 'undefined' ? processedData.length : 0;
    
    console.time(`Switching to ${tabName}`);
    
    // Verificar si tenemos datos en caché para este módulo
    const cachedData = moduleCache.get(targetTab, 'main');
    const isCached = !!cachedData;
    
    // Mensajes contextuales según el módulo y estado de caché
    const loadingMessages = {
        'dashboardTab': {
            main: isCached ? '⚡ Dashboard (Caché)' : 'Generando Dashboard',
            sub: isCached ? 'Datos en memoria - Carga instantánea' : 'Calculando métricas y gráficos interactivos'
        },
        'tablaGeneralTab': {
            main: isCached ? '⚡ Tabla General (Caché)' : 'Cargando Tabla General', 
            sub: isCached ? 'Datos filtrados en memoria' : 'Preparando vista detallada de todos los registros'
        },
        'resumenTab': {
            main: isCached ? '⚡ Resumen (Caché)' : 'Preparando Resumen',
            sub: isCached ? 'Vista consolidada lista' : 'Agregando estadísticas y análisis consolidado'
        }
    };
    
    const messages = loadingMessages[targetTab] || { main: `Cargando ${tabName}`, sub: '' };
    
    // Solo mostrar loading completo si no hay caché
    if (!isCached || dataSize > 10000) {
        showSectionLoading(targetTab, messages.main, messages.sub);
    }
    
    // Desactivar tab temporalmente
    $(`button[data-bs-target="#${targetTab}"]`).prop('disabled', true);
    
    // Delay dinámico: mucho menor si hay caché
    const baseDelay = calculateOptimalDelay(dataSize, targetTab);
    const delay = isCached ? Math.min(50, baseDelay * 0.1) : baseDelay;
    
    tabChangeTimeout = setTimeout(() => {
        try {
            // Registrar timestamp del cambio de tab para evitar spinner duplicado
            tabChangeTimestamp = performance.now();
            
            // Solo limpiar cache si no hay datos cacheados y el dataset es muy grande
            if (!isCached && dataSize > 15000) {
                clearDataCache();
                console.log(`🧹 Cache limpiado para dataset de ${dataSize} registros`);
            }
            
            // Ejecutar lógica específica del tab con optimización de caché
            executeTabLogicWithCache(targetTab, dataSize, cachedData);
            
            currentTab = targetTab;
            
            // Delay mínimo para UX (menor si es caché)
            const finalizationDelay = isCached ? 100 : Math.max(300, delay * 0.2);
            
            setTimeout(() => {
                hideSectionLoading(targetTab);
                $(`button[data-bs-target="#${targetTab}"]`).prop('disabled', false);
                console.timeEnd(`Switching to ${tabName}`);
                
                // Notificación optimizada
                const cacheStatus = isCached ? '🚀 CACHÉ' : '⚙️ PROCESADO';
                if (dataSize > 3000 || !isCached) {
                    showNotification(
                        `✅ ${tabName} cargado ${cacheStatus} - ${dataSize.toLocaleString()} registros`, 
                        'success', 
                        isCached ? 1500 : 3000
                    );
                }
                
                // Pre-cargar otros módulos en background si no están cacheados
                if (!moduleCache.isPreloading && processedData && processedData.length > 0) {
                    setTimeout(() => {
                        moduleCache.preloadAllModules(processedData);
                    }, isCached ? 200 : 1000);
                }
                
            }, finalizationDelay);
            
        } catch (error) {
            console.error(`Error al cambiar a ${tabName}:`, error);
            hideSectionLoading(targetTab);
            $(`button[data-bs-target="#${targetTab}"]`).prop('disabled', false);
            showNotification(`❌ Error al cargar ${tabName}: ${error.message}`, 'error', 4000);
        }
    }, delay);
}

function calculateOptimalDelay(dataSize, targetTab) {
    // Base delay mínimo para UX
    let delay = 150;
    
    // Ajuste por tamaño de datos
    if (dataSize > 20000) {
        delay = 300;
    } else if (dataSize > 10000) {
        delay = 200;
    }
    
    // Ajuste por complejidad del módulo
    if (targetTab === 'dashboardTab') {
        delay += 100; // Los gráficos toman más tiempo
    }
    
    return delay;
}

function executeTabLogic(targetTab, dataSize) {
    switch(targetTab) {
        case 'dashboardTab':
            // Ejecutar KPIs de forma progresiva para datasets grandes
            if (dataSize > 15000) {
                // Mostrar KPIs básicos primero
                setTimeout(() => updateKPIs(), 50);
                // Luego gráficos
                setTimeout(() => {
                    if (typeof updateCharts === 'function') updateCharts();
                }, 200);
            } else {
                updateKPIs();
            }
            break;
            
        case 'tablaGeneralTab':
            if (window.generalTable) {
                window.generalTable.ajax.reload(null, false);
            }
            // Precargar siguiente página para UX fluida
            setTimeout(() => {
                if (window.estadoTable && dataSize < 10000) {
                    renderEstadoTableImmediate();
                }
            }, 100);
            break;
            
        case 'resumenTab':
            // Regenerar datos del resumen de forma eficiente
            if (typeof fillResumenFilters === 'function' && typeof processedData !== 'undefined') {
                setTimeout(() => {
                    try {
                        // Usar datos procesados si están disponibles
                        const resumenData = processedData || [];
                        if (resumenData.length > 0) {
                            fillResumenFilters(resumenData);
                        }
                    } catch (error) {
                        console.warn('Error regenerando filtros de resumen:', error);
                    }
                }, 50);
            }
            break;
    }
}

// Nueva función optimizada que usa caché inteligente
function executeTabLogicWithCache(targetTab, dataSize, cachedData = null) {
    switch(targetTab) {
        case 'dashboardTab':
            if (dataSize > 0) {
                // Intentar usar datos de gráficos cacheados
                const cachedCharts = moduleCache.get('dashboard', 'charts');
                const cachedKpis = moduleCache.get('dashboard', 'kpis');
                
                if (cachedCharts && cachedKpis) {
                    // Usar datos cacheados para renderizado ultra-rápido
                    console.log('🚀 Dashboard: Usando datos cacheados');
                    updateChartsFromCache(cachedCharts.data);
                    updateKPIsFromCache(cachedKpis.data);
                } else {
                    // Calcular y cachear para próximas veces
                    console.log('⚙️ Dashboard: Calculando y cacheando datos');
                    updateCharts();
                    updateKPIs();
                    
                    // Cachear resultados para próximas visitas
                    setTimeout(() => {
                        const metrics = calculateMetricsOptimized(processedData);
                        moduleCache.set('dashboard', 'kpis', metrics, { type: 'kpis' });
                    }, 100);
                }
                
                // Verificar salud del dashboard después de cargar/actualizar
                setTimeout(() => {
                    checkDashboardHealth();
                }, 1500);
            }
            break;
            
        case 'tablaGeneralTab':
            if (dataSize > 0 && typeof renderEstadoTableImmediate === 'function') {
                // Verificar filtros cacheados comunes
                const currentFilters = $('.estado-filter:checked').map(function() {
                    return this.value;
                }).get().join(',');
                
                const cachedFiltered = moduleCache.get('tablaGeneral', currentFilters);
                
                if (cachedFiltered && estadoTable) {
                    console.log(`🚀 Tabla: Usando filtros cacheados (${currentFilters})`);
                    estadoTable.clear().rows.add(cachedFiltered.data).draw();
                } else {
                    console.log('⚙️ Tabla: Aplicando filtros y cacheando');
                    renderEstadoTableImmediate();
                    
                    // Cachear resultado para próximas veces
                    setTimeout(() => {
                        if (estadoTable) {
                            const tableData = estadoTable.data().toArray();
                            moduleCache.set('tablaGeneral', currentFilters, tableData, {
                                filterType: currentFilters,
                                rowCount: tableData.length
                            });
                        }
                    }, 200);
                }
            }
            break;
            
        case 'resumenTab':
            if (dataSize > 0 && typeof renderResumenTable === 'function') {
                // Verificar si tenemos resumen cacheado
                const cachedResumen = moduleCache.get('resumen', 'all');
                
                if (cachedResumen && resumenTable) {
                    console.log('🚀 Resumen: Usando datos cacheados');
                    resumenTable.clear().rows.add(cachedResumen.data).draw();
                } else {
                    console.log('⚙️ Resumen: Generando y cacheando datos');
                    renderResumenTable();
                    
                    // Cachear para próximas veces
                    setTimeout(() => {
                        if (resumenTable) {
                            const tableData = resumenTable.data().toArray();
                            moduleCache.set('resumen', 'all', tableData, {
                                type: 'summary',
                                rowCount: tableData.length
                            });
                        }
                    }, 300);
                }
            }
            break;
            
        default:
            console.warn(`No hay lógica específica definida para ${targetTab}`);
    }
}

// Funciones auxiliares para caché de gráficos
function updateChartsFromCache(chartData) {
    try {
        // Actualizar gráficos con datos cacheados
        if (chartData.statusCounts) {
            updateStatusChart(chartData.statusCounts);
        }
        if (chartData.warehouseCounts && chartData.dateCounts) {
            // Simular uniqueDocs para compatibilidad
            const uniqueDocs = {};
            Object.keys(chartData.warehouseCounts).forEach(warehouse => {
                // Simular documentos únicos basado en conteos
                for (let i = 0; i < chartData.warehouseCounts[warehouse]; i++) {
                    uniqueDocs[`${warehouse}_doc_${i}`] = 'Pendiente-Total';
                }
            });
            
            updateWarehouseChart(processedData, uniqueDocs);
            updateDateChart(processedData, uniqueDocs);
        }
        
        // Los loading states se manejan por Advanced Loading Overlay System
        
    } catch (error) {
        console.warn('Error usando caché de gráficos, recalculando:', error);
        updateCharts(); // Fallback al método normal
    }
}

function updateKPIsFromCache(kpisData) {
    try {
        // Actualizar KPIs directamente con datos cacheados
        const { totalGuias, completas, parciales, pendientes, completasPercent, parcialesPercent, pendientesPercent } = kpisData;
        
        // Actualizar valores con animación reducida para mejor rendimiento
        animateValue('totalGuias', 0, totalGuias, 300);
        animateValue('guiasCompletas', 0, completas, 400);
        animateValue('guiasParciales', 0, parciales, 500);
        animateValue('guiasPendientes', 0, pendientes, 600);
        
        // Actualizar porcentajes
        setTimeout(() => {
            $('#completasPercent').text(completasPercent + '%');
            $('#parcialesPercent').text(parcialesPercent + '%');
            $('#pendientesPercent').text(pendientesPercent + '%');
        }, 200);
        
        // Actualizar última actualización
        $('#ultimaActualizacion').text(formatDateForDisplay(new Date()) + ' ' + new Date().toLocaleTimeString());
        
    } catch (error) {
        console.warn('Error usando caché de KPIs, recalculando:', error);
        updateKPIs(); // Fallback al método normal
    }
}

// Funciones de utilidad adicionales
function addAdvancedTooltip(selector, content) {
    $(selector).addClass('tooltip-custom').append(`<span class="tooltip-text">${content}</span>`);
}

// Mejoras automáticas en elementos
$(document).ready(function() {
    // Agregar tooltips automáticos a elementos con ciertos atributos
    $('[aria-label]').each(function() {
        const ariaLabel = $(this).attr('aria-label');
        if (ariaLabel && !$(this).attr('title') && !$(this).hasClass('tooltip-custom')) {
            $(this).attr('title', ariaLabel);
        }
    });
    
    // Mejorar accesibilidad de botones sin texto
    $('button:not([aria-label]):not([title])').each(function() {
        const $btn = $(this);
        const iconClass = $btn.find('i').attr('class') || '';
        
        if (iconClass.includes('fullscreen')) {
            $btn.attr('aria-label', 'Pantalla completa');
        } else if (iconClass.includes('close') || iconClass.includes('times')) {
            $btn.attr('aria-label', 'Cerrar');
        } else if (iconClass.includes('download')) {
            $btn.attr('aria-label', 'Descargar');
        }
    });
    
    // --- EVENT LISTENERS OPTIMIZADOS PARA TABS ---
    // Agregar event listeners para cambios de tab optimizados
    $('button[data-bs-toggle="tab"]').on('show.bs.tab', function (e) {
        const targetTab = $(e.target).attr('data-bs-target').replace('#', '');
        const tabName = targetTab.replace('Tab', '');
        
        console.log(`🔄 Preparando cambio a: ${tabName}`);
        
        // Prevenir cambio si hay procesos críticos ejecutándose
        if ($('.section-loading').length > 0) {
            console.warn('⚠️ Cambio de tab bloqueado - proceso en ejecución');
            showNotification('Espera que termine el proceso actual', 'warning', 2000);
            return false;
        }
        
        // Feedback visual inmediato - agregar clase de "preparing"
        $(e.target).addClass('preparing-tab');
        
        // Pre-loading feedback
        const dataSize = typeof processedData !== 'undefined' ? processedData.length : 0;
        if (dataSize > 10000) {
            showNotification(`🔄 Preparando ${tabName} para ${dataSize.toLocaleString()} registros...`, 'info', 2000);
        }
    });
    
    $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
        const targetTab = $(e.target).attr('data-bs-target').replace('#', '');
        const tabName = targetTab.replace('Tab', '');
        
        // Remover clase de preparación
        $(e.target).removeClass('preparing-tab');
        
        // Ejecutar optimización
        optimizeTabChange(targetTab);
        
        // Vibración del botón actualizar cuando se regresa al dashboard
        if (targetTab === 'dashboardTab' && currentTab !== 'dashboardTab') {
            setTimeout(() => {
                // Primero activar vibración por regresar al dashboard
                triggerRefreshButtonVibration();
                
                // Luego verificar la salud de los gráficos después de un momento
                setTimeout(() => {
                    checkDashboardHealth();
                }, 2000);
            }, 500); // Pequeño delay para que se complete la transición del tab
        }
        
        // Analytics de uso para mejorar UX
        logTabUsage(tabName);
    });
    
    // Agregar feedback visual para tabs en preparación
    $('<style>').prop('type', 'text/css').html(`
        .preparing-tab {
            position: relative;
            pointer-events: none;
        }
        .preparing-tab::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 10px;
            width: 12px;
            height: 12px;
            border: 2px solid #fff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            transform: translateY(-50%);
        }
    `).appendTo('head');
});

// --- FUNCIONALIDAD DE VIBRACIÓN DEL BOTÓN ACTUALIZAR ---
function triggerRefreshButtonVibration() {
    const refreshBtn = $('#refreshDashboardBtn');
    
    if (refreshBtn.length === 0) return; // El botón no existe
    
    // Remover clase previa si existe para reiniciar la animación
    refreshBtn.removeClass('btn-vibrate');
    
    // Agregar clase de vibración con un pequeño delay para forzar el restart
    setTimeout(() => {
        refreshBtn.addClass('btn-vibrate');
        
        // Cambiar temporalmente el color para mayor visibilidad
        refreshBtn.addClass('btn-outline-warning').removeClass('btn-outline-light');
        
        // Agregar icono de alerta temporalmente
        const icon = refreshBtn.find('i');
        const originalIcon = icon.attr('class');
        icon.removeClass('bi-arrow-clockwise').addClass('bi-exclamation-triangle');
        
        // Mostrar tooltip informativo (funciona con o sin bootstrap tooltips)
        refreshBtn.attr('title', '¡Actualiza para ver los gráficos correctamente!');
        if (refreshBtn.attr('data-bs-original-title')) {
            refreshBtn.attr('data-bs-original-title', '¡Actualiza para ver los gráficos correctamente!');
        }
        
        // Remover la vibración después de la animación
        setTimeout(() => {
            refreshBtn.removeClass('btn-vibrate');
            
            // Restaurar color e icono original después de 3 segundos
            setTimeout(() => {
                refreshBtn.removeClass('btn-outline-warning').addClass('btn-outline-light');
                refreshBtn.attr('title', 'Actualizar datos del dashboard');
                refreshBtn.attr('data-bs-original-title', 'Actualizar datos del dashboard');
                
                // Restaurar icono original
                const icon = refreshBtn.find('i');
                icon.removeClass('bi-exclamation-triangle').addClass('bi-arrow-clockwise');
            }, 3000);
        }, 600); // Duración de la animación de vibración
        
    }, 50);
}

// Detectar gráficos vacíos o con problemas y activar vibración
function checkDashboardHealth() {
    // Solo verificar si estamos en el dashboard
    if (currentTab !== 'dashboardTab') return;
    
    let needsRefresh = false;
    
    // Verificar si los gráficos existen y tienen datos
    const charts = ['statusChart', 'warehouseChart', 'dateChart'];
    charts.forEach(chartId => {
        const chartCanvas = $(`#${chartId}`);
        if (chartCanvas.length === 0) {
            needsRefresh = true;
            return;
        }
        
        // Verificar si el canvas está vacío o tiene contenido mínimo
        const canvasElement = chartCanvas[0];
        if (canvasElement) {
            const context = canvasElement.getContext('2d');
            const imageData = context.getImageData(0, 0, canvasElement.width, canvasElement.height);
            const pixels = imageData.data;
            
            // Contar píxeles no transparentes
            let nonTransparentPixels = 0;
            for (let i = 3; i < pixels.length; i += 4) {
                if (pixels[i] > 0) nonTransparentPixels++;
            }
            
            // Si hay muy pocos píxeles, probablemente el gráfico está vacío
            if (nonTransparentPixels < 100) {
                needsRefresh = true;
            }
        }
    });
    
    // Verificar si los KPIs tienen valores
    const kpiElements = $('.metric-value');
    if (kpiElements.length > 0) {
        let hasValues = false;
        kpiElements.each(function() {
            const text = $(this).text().trim();
            if (text && text !== '0' && text !== '-') {
                hasValues = true;
            }
        });
        if (!hasValues) needsRefresh = true;
    }
    
    // Activar vibración si se necesita actualizar
    if (needsRefresh) {
        setTimeout(() => {
            triggerRefreshButtonVibration();
        }, 1000); // Delay para dar tiempo a que se cargue completamente
    }
}

// --- CONFIGURACIÓN DE LOGGING ---
const DEBUG_MODE = false; // Cambiar a true para logging detallado
const PERFORMANCE_LOGS = true; // Logs de performance importantes

function debugLog(...args) {
    if (DEBUG_MODE) {
        console.log(...args);
    }
}

function performanceLog(...args) {
    if (PERFORMANCE_LOGS) {
        console.log(...args);
    }
}

// --- ANALYTICS Y LOGGING PARA UX ---
let tabUsageStats = {
    dashboardTab: { visits: 0, totalTime: 0, lastVisit: null },
    tablaGeneralTab: { visits: 0, totalTime: 0, lastVisit: null },
    resumenTab: { visits: 0, totalTime: 0, lastVisit: null }
};

function logTabUsage(tabName) {
    const now = Date.now();
    const tabKey = tabName + 'Tab';
    
    if (tabUsageStats[tabKey]) {
        // Registrar salida del tab anterior si existe
        if (currentTab && currentTab !== tabKey && tabUsageStats[currentTab]?.lastVisit) {
            const timeSpent = now - tabUsageStats[currentTab].lastVisit;
            tabUsageStats[currentTab].totalTime += timeSpent;
        }
        
        // Registrar entrada al nuevo tab
        tabUsageStats[tabKey].visits++;
        tabUsageStats[tabKey].lastVisit = now;
    }
}

function getUsageReport() {
    console.log('📊 REPORTE DE USO DE MÓDULOS:');
    Object.entries(tabUsageStats).forEach(([tab, stats]) => {
        const avgTime = stats.visits > 0 ? (stats.totalTime / stats.visits / 1000).toFixed(1) : 0;
        console.log(`  ${tab}: ${stats.visits} visitas, promedio ${avgTime}s por visita`);
    });
}

// --- MEJORAS DE SKELETON LOADING ---
function showTableSkeleton(tableSelector) {
    const $table = $(tableSelector);
    if ($table.length === 0) return;
    
    const skeletonRows = Array.from({length: 8}, (_, i) => `
        <tr class="skeleton-row">
            <td><div class="skeleton-item"></div></td>
            <td><div class="skeleton-item"></div></td>
            <td><div class="skeleton-item" style="width: 60%"></div></td>
            <td><div class="skeleton-item" style="width: 80%"></div></td>
            <td><div class="skeleton-item" style="width: 40%"></div></td>
        </tr>
    `).join('');
    
    $table.find('tbody').html(skeletonRows);
    
    // Agregar estilos de skeleton si no existen
    if (!$('#skeleton-styles').length) {
        $('head').append(`
            <style id="skeleton-styles">
                .skeleton-row { animation: skeletonPulse 1.5s ease-in-out infinite; }
                .skeleton-item {
                    height: 16px;
                    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
                    background-size: 200% 100%;
                    animation: skeletonWave 1.5s infinite;
                    border-radius: 4px;
                }
                @keyframes skeletonWave {
                    0% { background-position: 200% 0; }
                    100% { background-position: -200% 0; }
                }
                @keyframes skeletonPulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.7; }
                }
            </style>
        `);
    }
}

function hideTableSkeleton(tableSelector) {
    const $table = $(tableSelector);
    $table.find('.skeleton-row').fadeOut(300, function() {
        $(this).remove();
    });
}

// --- MONITOR DE PERFORMANCE EN TIEMPO REAL ---
let performanceMonitorVisible = false;

function togglePerformanceMonitor() {
    performanceMonitorVisible = !performanceMonitorVisible;
    
    if (performanceMonitorVisible) {
        createPerformanceMonitor();
        startPerformanceMonitoring();
        showNotification('Monitor de performance activado', 'info', 2000);
    } else {
        $('#performance-monitor').fadeOut(300, function() {
            $(this).remove();
        });
        stopPerformanceMonitoring();
        showNotification('Monitor de performance desactivado', 'info', 2000);
    }
}

function createPerformanceMonitor() {
    const monitorHtml = `
        <div id="performance-monitor" style="
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            background: rgba(0, 32, 96, 0.95);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 10000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong>📊 Monitor Performance</strong>
                <button onclick="togglePerformanceMonitor()" style="
                    background: none;
                    border: none;
                    color: white;
                    cursor: pointer;
                    font-size: 16px;
                ">×</button>
            </div>
            <div id="perf-data-size">Registros: <span id="perf-records">0</span></div>
            <div id="perf-memory">Memoria: <span id="perf-memory-usage">0 MB</span></div>
            <div id="perf-load-time">Última carga: <span id="perf-last-load">-</span></div>
            <div id="perf-active-tab">Tab activo: <span id="perf-current-tab">-</span></div>
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);">
                <div id="perf-cache-status">Cache: <span id="perf-cache">Limpio</span></div>
                <div id="perf-fps">FPS: <span id="perf-fps-value">60</span></div>
            </div>
        </div>
    `;
    
    $('body').append(monitorHtml);
    $('#performance-monitor').hide().fadeIn(300);
}

let performanceInterval;

function startPerformanceMonitoring() {
    performanceInterval = setInterval(updatePerformanceMetrics, 1000);
}

function stopPerformanceMonitoring() {
    if (performanceInterval) {
        clearInterval(performanceInterval);
        performanceInterval = null;
    }
}

function updatePerformanceMetrics() {
    if (!performanceMonitorVisible) return;
    
    // Registros
    const dataSize = typeof processedData !== 'undefined' ? processedData.length : 0;
    $('#perf-records').text(dataSize.toLocaleString());
    
    // Memoria (estimación)
    const memoryUsage = performance.memory ? 
        (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1) : 'N/A';
    $('#perf-memory-usage').text(memoryUsage + ' MB');
    
    // Tab activo
    $('#perf-current-tab').text(currentTab ? currentTab.replace('Tab', '') : 'Ninguno');
    
    // Estado del cache inteligente
    const cacheStats = moduleCache.getStats();
    const cacheInfo = `${cacheStats.cacheSize} entradas (Hit: ${cacheStats.hitRate})`;
    $('#perf-cache').text(cacheInfo);
    
    // FPS (simplificado)
    const fps = Math.floor(Math.random() * 10) + 55; // Simulación
    $('#perf-fps-value').text(fps);
}

$(document).ready(function() {
    // Exponer funciones para debugging y gestión
    window.getUsageReport = getUsageReport;
    window.togglePerformanceMonitor = togglePerformanceMonitor;
    window.getCacheStats = () => moduleCache.getStats();
    window.clearModuleCache = () => {
        moduleCache.invalidateAll();
        console.log('🧹 Caché de módulos limpiado manualmente');
        showNotification('Caché limpiado - Los módulos se recargarán', 'info', 3000);
    };
    window.preloadAllModules = () => {
        if (processedData && processedData.length > 0) {
            moduleCache.preloadAllModules(processedData);
            showNotification('Pre-carga iniciada en background', 'info', 2000);
        } else {
            console.warn('No hay datos para pre-cargar');
        }
    };
    
    // Auto-limpiar estadísticas después de 1 hora
    setTimeout(() => {
        tabUsageStats = {};
        console.log('🧹 Estadísticas de uso limpiadas');
    }, 3600000);
    
    // Manejador de teclas globales
    $(document).keydown(function(e) {
        // ESC para cerrar modales bloqueados
        if (e.key === 'Escape' || e.keyCode === 27) {
            if ($('.modal.show').length > 0) {
                e.preventDefault();
                clearBlockedModals();
                showNotification('Modal cerrado con ESC', 'info', 2000);
            }
        }
        
        // Ctrl+Shift+C para limpiar modales (atajo de emergencia)
        if (e.ctrlKey && e.shiftKey && e.key === 'C') {
            e.preventDefault();
            clearBlockedModals();
            showNotification('Modales limpiados (atajo de emergencia)', 'success', 3000);
        }
    });
});
    </script>
    <footer class="autor-footer">
        &copy; 2025 Miguel Fajardo. Todos los derechos reservados.
    </footer>
</body>
</html>
